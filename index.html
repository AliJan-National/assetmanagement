<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Water Assets Management System | Intelligent Asset Monitoring</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js datalabels plugin for showing percentages inside pie chart -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

  <style>
    :root {
      --primary-blue: #0066cc;
      --primary-blue-dark: #0052a3;
      --primary-blue-light: #3385d6;
      --accent-teal: #00b4d8;
      --accent-teal-light: #48cae4;
      --success-green: #00b894;
      --warning-orange: #f39c12;
      --danger-red: #e74c3c;
      --critical-dark: #c0392b;
      --neutral-gray: #6c757d;
      --light-gray: #f8f9fa;
      --dark-gray: #343a40;
      --white: #ffffff;
      --shadow-light: rgba(0, 102, 204, 0.1);
      --shadow-medium: rgba(0, 0, 0, 0.08);
      --shadow-dark: rgba(0, 0, 0, 0.12);
      --gradient-primary: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-teal) 100%);
      --gradient-success: linear-gradient(135deg, var(--success-green) 0%, #00d2a0 100%);
      --gradient-warning: linear-gradient(135deg, var(--warning-orange) 0%, #f5b041 100%);
      --gradient-danger: linear-gradient(135deg, var(--danger-red) 0%, #ff6b6b 100%);
      --border-radius-sm: 8px;
      --border-radius-md: 12px;
      --border-radius-lg: 16px;
      --border-radius-xl: 20px;
      --transition-fast: 0.2s ease;
      --transition-medium: 0.3s ease;
      
      /* Theme Variables - Light Theme (Default) */
      --theme-bg: #f5f7fa;
      --theme-panel-bg: #ffffff;
      --theme-panel-border: #e0e0e0;
      --theme-panel-shadow: 5px 0 25px rgba(0, 0, 0, 0.1);
      --theme-text: #343a40;
      --theme-card-bg: #ffffff;
      --theme-card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --theme-input-bg: #ffffff;
      --theme-input-border: #e9ecef;
      --theme-input-text: #343a40;
      --theme-section-bg: #f8f9fa;
      --theme-section-border: #e9ecef;
      --theme-header-bg: #ffffff;
      --theme-header-border: #dee2e6;
      --theme-map-controls-bg: #ffffff;
      --theme-map-controls-border: #e0e0e0;
      --theme-map-controls-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      --theme-zoom-bg: #ffffff;
      --theme-zoom-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      --theme-chart-bg: #ffffff;
      --theme-chart-border: #e9ecef;
      --theme-chart-shadow: 0 10px 40px rgba(0, 102, 204, 0.15);
      --theme-scrollbar-track: #f1f1f1;
      --theme-scrollbar-thumb: #c1c1c1;
    }

    /* Dark Theme Variables - UPDATED: Flat, uniform design without gradients */
    body.dark-theme {
      --theme-bg: #0d1117;
      --theme-panel-bg: #161b22;
      --theme-panel-border: #30363d;
      --theme-panel-shadow: 5px 0 25px rgba(0, 0, 0, 0.4);
      --theme-text: #e6edf3;
      --theme-card-bg: #161b22;
      --theme-card-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      --theme-input-bg: #0d1117;
      --theme-input-border: #30363d;
      --theme-input-text: #e6edf3;
      --theme-section-bg: #161b22;
      --theme-section-border: #30363d;
      --theme-header-bg: #161b22;
      --theme-header-border: #30363d;
      --theme-map-controls-bg: #161b22;
      --theme-map-controls-border: #30363d;
      --theme-map-controls-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      --theme-zoom-bg: #161b22;
      --theme-zoom-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      --theme-chart-bg: #161b22;
      --theme-chart-border: #30363d;
      --theme-chart-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      --theme-scrollbar-track: #0d1117;
      --theme-scrollbar-thumb: #30363d;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--theme-bg);
      overflow: hidden;
      color: var(--theme-text);
      height: 100vh;
      display: flex;
      transition: background var(--transition-medium), color var(--transition-medium);
    }

    #map {
      flex: 1;
      height: 100vh;
      z-index: 1;
    }

    /* Main container for side panels */
    .panels-container {
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: 0;
      width: 350px;
      height: 100vh;
      z-index: 2000;
      pointer-events: none;
    }

    /* Control Panel - Left Fixed Panel */
    .control-panel {
      background: var(--theme-panel-bg);
      border-right: 1px solid var(--theme-panel-border);
      box-shadow: var(--theme-panel-shadow);
      height: 100vh;
      width: 350px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      pointer-events: auto;
      transition: transform 0.3s ease, background var(--transition-medium), border-color var(--transition-medium), box-shadow var(--transition-medium);
    }

    .control-panel.hidden {
      transform: translateX(-100%);
    }

    /* Tab Navigation Styles */
    .panel-tabs {
      display: flex;
      background: var(--theme-section-bg);
      border-bottom: 1px solid var(--theme-section-border);
      padding: 0;
      flex-shrink: 0;
    }

    .panel-tab {
      flex: 1;
      padding: 15px;
      background: none;
      border: none;
      color: var(--theme-text);
      font-weight: 600;
      font-size: 0.9em;
      cursor: pointer;
      transition: all var(--transition-fast);
      border-bottom: 3px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .panel-tab:hover {
      background: var(--theme-input-bg);
    }

    .panel-tab.active {
      color: var(--primary-blue);
      border-bottom-color: var(--primary-blue);
      background: var(--theme-panel-bg);
    }

    .panel-tab i {
      font-size: 0.9em;
    }

    .panel-header {
      padding: 15px 20px;
      border-bottom: 1px solid var(--theme-header-border);
      background: var(--theme-header-bg);
      flex-shrink: 0;
      transition: background var(--transition-medium), border-color var(--transition-medium);
    }

    .panel-header h2 {
      color: var(--theme-text);
      font-size: 1.2em;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-header h2 i {
      color: var(--accent-teal);
      font-size: 1.2em;
    }

    .close-panel {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 22px;
      color: var(--neutral-gray);
      cursor: pointer;
      padding: 6px;
      border-radius: var(--border-radius-sm);
      transition: all var(--transition-fast);
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .close-panel:hover {
      color: var(--danger-red);
      background: rgba(231, 76, 60, 0.1);
      transform: rotate(90deg);
    }

    /* Dashboard Content Area - Optimized for no scrolling */
    .dashboard-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    /* Dashboard Toggle Button */
    .dashboard-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 999;
      background: var(--gradient-primary);
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(0, 102, 204, 0.3);
      transition: all var(--transition-medium);
      border: 3px solid white;
      pointer-events: auto;
    }

    .dashboard-toggle:hover {
      transform: scale(1.1) rotate(15deg);
      box-shadow: 0 12px 30px rgba(0, 102, 204, 0.4);
    }

    .dashboard-toggle.hidden {
      left: 20px;
    }

    /* UPDATED: Stats Grid - Now 3 columns in single row for Asset, 6 columns for Site */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }

    /* UPDATED: Site Stats Grid - Now 2 rows Ã— 3 columns */
    .stats-grid.site-stats {
      grid-template-columns: repeat(3, 1fr);
    }

    /* Remove the responsive overrides that changed columns */
    @media (min-width: 1200px) {
      .stats-grid.site-stats {
        grid-template-columns: repeat(3, 1fr); /* Changed from 6 to 3 */
      }
    }

    @media (max-width: 1199px) and (min-width: 768px) {
      .stats-grid.site-stats {
        grid-template-columns: repeat(3, 1fr); /* Keep 3 columns */
      }
    }

    @media (max-width: 767px) {
      .stats-grid.site-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .stat-card {
      background: var(--theme-card-bg);
      padding: 10px;
      border-radius: var(--border-radius-md);
      border-left: 4px solid;
      transition: all var(--transition-medium);
      cursor: pointer;
      box-shadow: var(--theme-card-shadow);
      min-height: 60px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px var(--shadow-dark);
    }

    .stat-card.total { 
      border-left-color: var(--primary-blue);
    }
    .stat-card.working { 
      border-left-color: var(--success-green);
    }
    .stat-card.not-working { 
      border-left-color: var(--danger-red);
    }
    .stat-card.standby { 
      border-left-color: #FFD166; /* Golden Yellow */
    }
    .stat-card.out-of-service { 
      border-left-color: #FF9E6D; /* Burnt Orange */
    }
    .stat-card.cwip { 
      border-left-color: #9D4EDD; /* Royal Purple */
    }
    .stat-card.transfer { 
      border-left-color: #00A8FF; /* Electric Blue */
    }

    .stat-card h3 {
      font-size: 0.65em;
      color: var(--neutral-gray);
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stat-value {
      font-size: 1.2em;
      font-weight: 800;
      color: var(--theme-text);
      margin-bottom: 2px;
      line-height: 1;
    }

    .stat-percent {
      font-size: 0.65em;
      padding: 2px 6px;
      border-radius: 10px;
      display: inline-block;
      font-weight: 600;
    }

    .stat-card.total .stat-percent { 
      background: rgba(0, 102, 204, 0.1); 
      color: var(--primary-blue); 
    }
    .stat-card.working .stat-percent { 
      background: rgba(0, 184, 148, 0.1); 
      color: var(--success-green); 
    }
    .stat-card.not-working .stat-percent { 
      background: rgba(231, 76, 60, 0.1); 
      color: var(--danger-red); 
    }
    .stat-card.standby .stat-percent { 
      background: rgba(255, 209, 102, 0.1); 
      color: #FFD166; 
    }
    .stat-card.out-of-service .stat-percent { 
      background: rgba(255, 158, 109, 0.1); 
      color: #FF9E6D; 
    }
    .stat-card.cwip .stat-percent { 
      background: rgba(157, 78, 221, 0.1); 
      color: #9D4EDD; 
    }
    .stat-card.transfer .stat-percent { 
      background: rgba(0, 168, 255, 0.1); 
      color: #00A8FF; 
    }

    /* Compact Filters */
    .filters-section {
      background: var(--theme-section-bg);
      padding: 15px;
      border-radius: var(--border-radius-lg);
      margin-bottom: 15px;
      border: 1px solid var(--theme-section-border);
      transition: background var(--transition-medium), border-color var(--transition-medium);
    }

    .filters-section h3 {
      color: var(--theme-text);
      margin-bottom: 12px;
      font-size: 1em;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
    }

    .filter-group {
      margin-bottom: 12px;
    }

    .filter-group label {
      display: block;
      margin-bottom: 5px;
      color: var(--theme-text);
      font-weight: 600;
      font-size: 0.8em;
    }

    .filter-group select {
      width: 100%;
      padding: 8px 12px;
      border: 2px solid var(--theme-input-border);
      border-radius: var(--border-radius-md);
      background: var(--theme-input-bg);
      color: var(--theme-input-text);
      font-size: 12px;
      transition: all var(--transition-fast);
      font-weight: 500;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%230066cc' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 10px;
      padding-right: 30px;
    }

    /* Dark theme select arrow */
    body.dark-theme .filter-group select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2300b4d8' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    }

    /* Compact Legend */
    .legend {
      background: var(--theme-card-bg);
      padding: 15px;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--theme-card-shadow);
      margin-bottom: 15px;
    }

    .legend h3 {
      color: var(--theme-text);
      margin-bottom: 12px;
      font-size: 1em;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
    }

    .legend-items {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 8px;
      border-radius: var(--border-radius-sm);
      transition: all var(--transition-fast);
      font-size: 0.85em;
    }

    .legend-color {
      width: 15px;
      height: 15px;
      border-radius: 3px;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* REDESIGNED Equipment Panel - NOW CITY OVERVIEW */
    .equipment-panel {
      position: fixed;
      top: 0;
      right: 0;
      height: 100vh;
      width: 380px; /* Reduced from 400px */
      min-width: 280px;
      max-width: 60%;
      background: var(--theme-panel-bg);
      border-left: 1px solid var(--theme-panel-border);
      box-shadow: var(--theme-panel-shadow);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      pointer-events: auto;
      transition: all var(--transition-medium);
      box-sizing: border-box;
      overflow-y: auto; /* Changed from auto to auto for scroll only when needed */
    }

    .equipment-panel.hidden {
      transform: translateX(calc(100% + 20px));
    }

    .equipment-header {
      padding: 16px 20px; /* Reduced padding */
      border-bottom: 1px solid var(--theme-header-border);
      background: var(--theme-header-bg);
      color: var(--theme-text);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .equipment-header h3 {
      font-size: 1.2em; /* Reduced from 1.3em */
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px; /* Reduced from 12px */
    }

    /* Site Name Display in Panel */
    .site-name-highlight {
      background: var(--theme-section-bg);
      padding: 8px 12px; /* Reduced padding */
      border-radius: var(--border-radius-md);
      margin: 8px 16px; /* Reduced margin */
      font-weight: 600;
      color: var(--primary-blue);
      border-left: 4px solid var(--primary-blue);
      text-align: center;
      font-size: 1em; /* Reduced from 1.1em */
    }

    /* FIXED Equipment Content Layout */
    .equipment-content {
      flex: 1;
      padding: 16px; /* Reduced from 20px */
      display: flex;
      flex-direction: column;
      gap: 16px; /* Reduced from 20px */
      overflow-y: auto;
      min-height: 0;
      position: relative;
    }

    /* Stats Summary Cards */
    .stats-summary {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px; /* Reduced from 15px */
      flex-shrink: 0;
    }

    .summary-card {
      background: var(--theme-card-bg);
      padding: 10px; /* Reduced from 12px */
      border-radius: var(--border-radius-md);
      border: 1px solid var(--theme-section-border);
      box-shadow: var(--theme-card-shadow);
      text-align: left;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 60px; /* Reduced from 70px */
    }

    .summary-card.total-equipment {
      border-top: 4px solid var(--primary-blue);
    }

    .summary-card.critical-equipment {
      border-top: 4px solid var(--danger-red);
    }

    .summary-card h4 {
      font-size: 0.65em; /* Reduced from 0.7em */
      color: var(--neutral-gray);
      margin-bottom: 4px; /* Reduced from 6px */
      text-transform: uppercase;
      letter-spacing: 0.8px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px; /* Reduced from 5px */
    }

    .summary-value {
      font-size: 1.2em; /* Reduced from 1.4em */
      font-weight: 800;
      color: var(--theme-text);
      margin-bottom: 2px;
      line-height: 1;
    }

    .summary-label {
      color: var(--neutral-gray);
      font-size: 0.65em; /* Reduced from 0.7em */
      font-weight: 500;
    }

    /* ========== ENHANCED CHART SECTION ========== */
    .chart-section {
      flex: 0 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 8px; /* Reduced from 10px */
      width: 100%;
    }

    .chart-section h4 {
      font-size: 0.95em; /* Reduced from 1em */
      color: var(--theme-text);
      margin-bottom: 12px; /* Reduced from 15px */
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px; /* Reduced from 8px */
      align-self: flex-start;
    }

    /* PROFESSIONAL Chart Container - OPTIMIZED SIZE */
    .chart-container-wrapper {
      width: 320px; /* Reduced from 340px */
      height: 320px; /* Reduced from 340px */
      position: relative;
      background: var(--theme-chart-bg);
      border-radius: var(--border-radius-lg);
      padding: 12px; /* Reduced from 15px */
      box-shadow: var(--theme-chart-shadow);
      border: 1px solid var(--theme-chart-border);
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      margin: 0 auto;
    }
    
    .chart-container-wrapper::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, 
        var(--primary-blue) 0%, 
        var(--accent-teal) 33%, 
        var(--success-green) 66%, 
        var(--warning-orange) 100%);
      z-index: 2;
      border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
    }

    #equipmentChart {
      width: 296px !important; /* Reduced from 310px */
      height: 296px !important; /* Reduced from 310px */
      z-index: 2;
    }

    /* Distribution Container at Bottom - OPTIMIZED FOR NO SCROLLING */
    .distribution-container {
      margin-top: auto;
      background: var(--theme-section-bg);
      border-radius: var(--border-radius-lg);
      padding: 16px; /* Reduced from 20px */
      border: 1px solid var(--theme-section-border);
      box-shadow: var(--theme-card-shadow);
      backdrop-filter: blur(10px);
      max-height: 320px; /* Limit max height */
      overflow-y: auto; /* Enable scroll only if needed */
    }

    .distribution-container h4 {
      font-size: 0.95em; /* Reduced from 1em */
      color: var(--theme-text);
      margin-bottom: 12px; /* Reduced from 15px */
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px; /* Reduced from 8px */
      flex-shrink: 0;
      height: 24px; /* Reduced from 30px */
    }

    .distribution-container h4 i {
      color: var(--danger-red);
    }

    /* OPTIMIZED Grid layout for distribution items - NOW 4 COLUMNS */
    .distribution-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr); /* Changed from 3 to 4 columns */
      gap: 10px; /* Reduced from 12px */
    }

    /* OPTIMIZED distribution item - COMPACT DESIGN */
    .distribution-item {
      display: flex;
      flex-direction: column; /* Changed from row to column */
      align-items: center;
      text-align: center;
      gap: 6px; /* Reduced from 12px */
      background: var(--theme-card-bg);
      padding: 10px 6px; /* Reduced padding */
      border-radius: var(--border-radius-md);
      border-top: 4px solid; /* Changed from border-left to border-top */
      box-shadow: var(--theme-card-shadow);
      transition: all var(--transition-fast);
      min-height: 80px; /* Reduced from taller size */
      min-width: 0; /* Allow shrinking */
      overflow: hidden;
    }

    .distribution-item:hover {
      transform: translateY(-2px); /* Reduced from -3px */
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }

    .distribution-item.EXCELLENT { 
      border-top-color: #00FF9D;
    }
    .distribution-item.VERY_GOOD { 
      border-top-color: #00C896;
    }
    .distribution-item.GOOD { 
      border-top-color: #00A8FF;
    }
    .distribution-item.NEW { 
      border-top-color: #9D4EDD;
    }
    .distribution-item.FAIR { 
      border-top-color: #FFD166;
    }
    .distribution-item.POOR { 
      border-top-color: #FF9E6D;
    }
    .distribution-item.CRITICAL { 
      border-top-color: #FF5252;
    }
    .distribution-item.UNKNOWN { 
      border-top-color: #6D6A75;
    }
    .distribution-item.WORKING { 
      border-top-color: #00b894;
    }
    .distribution-item.STANDBY { 
      border-top-color: #FFD166;
    }
    .distribution-item.OUT_OF_SERVICE { 
      border-top-color: #FF9E6D;
    }
    .distribution-item.CWIP { 
      border-top-color: #9D4EDD;
    }
    .distribution-item.TRANSFER { 
      border-top-color: #00A8FF;
    }

    /* UPDATED: WABS and WWPS colors for better differentiation - WWPS stays pink/red, WABS changed to teal/cyan */
    .distribution-item.WTNK { 
      border-top-color: #36A2EB;
    }
    .distribution-item.WWPS { 
      border-top-color: #FF6384; /* Pink/red - kept same */
    }
    .distribution-item.WWTP { 
      border-top-color: #FFCE56;
    }
    .distribution-item.WFLS { 
      border-top-color: #4BC0C0;
    }
    .distribution-item.WPUS { 
      border-top-color: #9966FF;
    }
    .distribution-item.WTRP { 
      border-top-color: #FF9F40;
    }
    .distribution-item.WABS { 
      border-top-color: #00D4AA; /* Changed to teal/cyan for clear distinction */
    }

    .distribution-icon {
      width: 32px; /* Reduced from 36px */
      height: 32px; /* Reduced from 36px */
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px; /* Reduced from 14px */
      flex-shrink: 0;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1); /* Reduced shadow */
    }

    .distribution-item.EXCELLENT .distribution-icon { 
      background: #00FF9D; 
      color: #0d1117; 
    }
    .distribution-item.VERY_GOOD .distribution-icon { 
      background: #00C896; 
      color: #0d1117; 
    }
    .distribution-item.GOOD .distribution-icon { 
      background: #00A8FF; 
      color: white; 
    }
    .distribution-item.NEW .distribution-icon { 
      background: #9D4EDD; 
      color: white; 
    }
    .distribution-item.FAIR .distribution-icon { 
      background: #FFD166; 
      color: #0d1117; 
    }
    .distribution-item.POOR .distribution-icon { 
      background: #FF9E6D; 
      color: white; 
    }
    .distribution-item.CRITICAL .distribution-icon { 
      background: #FF5252; 
      color: white; 
    }
    .distribution-item.UNKNOWN .distribution-icon { 
      background: #6D6A75; 
      color: white; 
    }
    .distribution-item.WORKING .distribution-icon { 
      background: #00b894; 
      color: white; 
    }
    .distribution-item.STANDBY .distribution-icon { 
      background: #FFD166; 
      color: #0d1117; 
    }
    .distribution-item.OUT_OF_SERVICE .distribution-icon { 
      background: #FF9E6D; 
      color: white; 
    }
    .distribution-item.CWIP .distribution-icon { 
      background: #9D4EDD; 
      color: white; 
    }
    .distribution-item.TRANSFER .distribution-icon { 
      background: #00A8FF; 
      color: white; 
    }

    /* UPDATED: WABS and WWPS colors for better differentiation */
    .distribution-item.WTNK .distribution-icon { 
      background: #36A2EB; 
      color: white; 
    }
    .distribution-item.WWPS .distribution-icon { 
      background: #FF6384; /* Pink/red - kept same */
      color: white; 
    }
    .distribution-item.WWTP .distribution-icon { 
      background: #FFCE56; 
      color: #0d1117; 
    }
    .distribution-item.WFLS .distribution-icon { 
      background: #4BC0C0;
      color: white; 
    }
    .distribution-item.WPUS .distribution-icon { 
      background: #9966FF; 
      color: white; 
    }
    .distribution-item.WTRP .distribution-icon { 
      background: #FF9F40; 
      color: white; 
    }
    .distribution-item.WABS .distribution-icon { 
      background: #00D4AA; /* Changed to teal/cyan for clear distinction */
      color: #0d1117; 
    }

    .distribution-info {
      display: flex;
      flex-direction: column;
      gap: 3px; /* Reduced from 4px */
      flex: 1;
      width: 100%;
    }

    .distribution-name {
      font-weight: 600;
      color: var(--theme-text);
      font-size: 0.75em; /* Reduced from 0.85em */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .distribution-count {
      font-size: 1.1em; /* Reduced from 1.3em */
      font-weight: 800;
      color: var(--theme-text);
      line-height: 1;
    }

    .distribution-subtext {
      font-size: 0.7em; /* Reduced from 0.75em */
      color: var(--neutral-gray);
      opacity: 0.8;
    }

    /* Equipment Toggle Button - Position Adjusted */
    .equipment-toggle {
      position: fixed;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      z-index: 999;
      background: var(--gradient-primary);
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(0, 102, 204, 0.4);
      transition: all var(--transition-medium);
      border: 4px solid white;
      pointer-events: auto;
    }

    .equipment-toggle:hover {
      transform: translateY(-50%) scale(1.1);
      box-shadow: 0 15px 40px rgba(0, 102, 204, 0.5);
    }

    .equipment-toggle.hidden {
      right: 20px;
    }

    /* Site Name Display (Replaces Search Box) */
    .site-name-display {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      pointer-events: none;
      max-width: 500px;
      width: auto;
      text-align: center;
    }

    .site-name-container {
      background: var(--theme-card-bg);
      color: var(--theme-text);
      padding: 12px 30px;
      border-radius: var(--border-radius-xl);
      box-shadow: var(--theme-card-shadow);
      border: 1px solid var(--theme-section-border);
      min-width: 300px;
      opacity: 0;
      transition: all var(--transition-medium);
      transform: translateY(-20px);
      pointer-events: auto;
    }

    .site-name-container.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .site-name-container h2 {
      font-size: 1.5em;
      font-weight: 800;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      letter-spacing: 0.5px;
    }

    .site-name-container h2 i {
      color: var(--primary-blue);
      font-size: 1.3em;
    }

    .site-name-container .site-count {
      font-size: 0.85em;
      opacity: 0.9;
      margin-top: 5px;
      font-weight: 500;
      background: var(--theme-section-bg);
      padding: 3px 10px;
      border-radius: 20px;
      display: inline-block;
    }

    /* NEW: Bottom Panel with Tabs */
    .bottom-panel {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 800px;
      max-width: 90%;
      background: var(--theme-map-controls-bg);
      border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
      box-shadow: var(--theme-map-controls-shadow);
      border: 1px solid var(--theme-map-controls-border);
      border-bottom: none;
      z-index: 1000;
      overflow: hidden;
      pointer-events: auto;
    }

    .bottom-panel-tabs {
      display: flex;
      background: var(--theme-section-bg);
      border-bottom: 1px solid var(--theme-section-border);
      padding: 0;
    }

    .bottom-panel-tab {
      flex: 1;
      padding: 12px 20px;
      background: none;
      border: none;
      color: var(--theme-text);
      font-weight: 600;
      font-size: 0.9em;
      cursor: pointer;
      transition: all var(--transition-fast);
      border-bottom: 3px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .bottom-panel-tab:hover {
      background: var(--theme-input-bg);
    }

    .bottom-panel-tab.active {
      color: var(--primary-blue);
      border-bottom-color: var(--primary-blue);
      background: var(--theme-panel-bg);
    }

    .bottom-panel-content {
      padding: 15px 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Map View Tab Content */
    .map-view-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 15px;
    }

    .map-view-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .map-view-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .map-view-content h4 {
      font-size: 0.9em;
      color: var(--theme-text);
      margin: 0;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .layer-options {
      display: flex;
      gap: 5px;
    }

    .layer-option {
      padding: 8px 16px;
      background: var(--theme-section-bg);
      border: 1px solid var(--theme-input-border);
      border-radius: var(--border-radius-md);
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 600;
      color: var(--theme-text);
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .layer-option:hover {
      background: var(--theme-input-bg);
      border-color: var(--primary-blue-light);
    }

    .layer-option.active {
      background: var(--primary-blue);
      color: white;
      border-color: var(--primary-blue);
      box-shadow: 0 4px 12px rgba(0, 102, 204, 0.2);
    }

    .layer-option i {
      font-size: 1em;
    }

    /* Theme Toggle Button */
    .theme-toggle {
      padding: 8px 16px;
      background: var(--theme-section-bg);
      border: 1px solid var(--theme-input-border);
      border-radius: var(--border-radius-md);
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 600;
      color: var(--theme-text);
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .theme-toggle:hover {
      background: var(--theme-input-bg);
      border-color: var(--primary-blue-light);
      transform: translateY(-1px);
    }

    body.dark-theme .theme-toggle {
      background: var(--theme-input-bg);
    }

    /* City Tour Tab Content */
    .city-tour-content {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .city-tour-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .city-tour-header h4 {
      font-size: 0.95em;
      color: var(--theme-text);
      margin: 0;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .city-tour-header h4 i {
      color: var(--accent-teal);
    }

    .city-tour-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
    }

    .city-tour-buttons {
      display: flex;
      gap: 10px;
    }

    .tour-button {
      padding: 10px 20px;
      background: var(--primary-blue);
      color: white;
      border: none;
      border-radius: var(--border-radius-md);
      font-weight: 600;
      font-size: 0.9em;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-width: 100px;
    }

    .tour-button:hover {
      background: var(--primary-blue-dark);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 102, 204, 0.2);
    }

    .tour-button:disabled {
      background: var(--neutral-gray);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      opacity: 0.6;
    }

    .tour-button.play {
      background: var(--success-green);
    }

    .tour-button.play:hover {
      background: #00a884;
    }

    .tour-button.pause {
      background: var(--warning-orange);
    }

    .tour-button.pause:hover {
      background: #e67e22;
    }

    .tour-button.stop {
      background: var(--danger-red);
    }

    .tour-button.stop:hover {
      background: #c0392b;
    }

    .tour-speed-control {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 200px;
    }

    .tour-speed-control label {
      font-size: 0.85em;
      color: var(--theme-text);
      font-weight: 600;
      white-space: nowrap;
    }

    .tour-speed-slider {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 6px;
      background: var(--theme-input-bg);
      border-radius: 3px;
      outline: none;
    }

    .tour-speed-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: var(--primary-blue);
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .tour-speed-slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: var(--primary-blue);
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .tour-speed-value {
      font-size: 0.85em;
      color: var(--primary-blue);
      font-weight: 700;
      min-width: 40px;
      text-align: right;
    }

    /* REMOVED: City Tour Notification - This is the popup we want to remove */
    /* The entire .city-tour-notification CSS has been removed */

    /* Health Status Indicator at Bottom of Filter Panel */
    .health-indicator {
      background: var(--theme-section-bg);
      border-radius: var(--border-radius-lg);
      padding: 15px;
      margin-top: 10px;
      border: 1px solid var(--theme-section-border);
      box-shadow: var(--theme-card-shadow);
      flex-shrink: 0;
    }

    .health-indicator h4 {
      font-size: 0.95em;
      color: var(--theme-text);
      margin-bottom: 12px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .health-indicator h4 i {
      color: var(--success-green);
    }

    .health-bar {
      height: 24px;
      background: var(--theme-input-bg);
      border-radius: var(--border-radius-md);
      overflow: hidden;
      margin-bottom: 10px;
      position: relative;
      border: 1px solid var(--theme-input-border);
    }

    .health-fill {
      height: 100%;
      border-radius: var(--border-radius-md);
      background: linear-gradient(90deg, 
        var(--danger-red) 0%, 
        var(--warning-orange) 33%, 
        var(--success-green) 66%, 
        var(--primary-blue) 100%);
      transition: width 0.8s ease;
      position: relative;
      overflow: hidden;
    }

    .health-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8em;
      color: var(--neutral-gray);
    }

    .health-score {
      font-weight: 800;
      font-size: 1.2em;
      color: var(--theme-text);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .health-label {
      font-weight: 600;
    }

    @keyframes shine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* Quick Actions */
    .quick-actions {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .quick-action {
      background: var(--theme-card-bg);
      border: 1px solid var(--theme-section-border);
      border-radius: var(--border-radius-md);
      padding: 8px;
      font-size: 0.75em;
      font-weight: 600;
      color: var(--theme-text);
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      text-align: center;
    }

    .quick-action:hover {
      background: var(--theme-input-bg);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 102, 204, 0.1);
    }

    .quick-action i {
      font-size: 1em;
    }

    .quick-action.critical {
      color: var(--danger-red);
      border-color: rgba(231, 76, 60, 0.3);
    }

    .quick-action.working {
      color: var(--success-green);
      border-color: rgba(0, 184, 148, 0.3);
    }

    /* Zoom level indicator */
    .zoom-level {
      position: fixed;
      bottom: 90px;
      right: 20px;
      z-index: 1000;
      background: var(--theme-zoom-bg);
      padding: 8px 16px;
      border-radius: var(--border-radius-md);
      box-shadow: var(--theme-zoom-shadow);
      font-weight: 600;
      color: var(--primary-blue);
      display: block;
      font-size: 0.9em;
      pointer-events: auto;
      border: 1px solid var(--theme-section-border);
    }

    /* Scale indicator */
    .scale-indicator {
      position: fixed;
      bottom: 90px;
      left: 20px;
      z-index: 1000;
      background: var(--theme-zoom-bg);
      padding: 8px 16px;
      border-radius: var(--border-radius-md);
      box-shadow: var(--theme-zoom-shadow);
      font-weight: 600;
      color: var(--primary-blue);
      display: block;
      font-size: 0.9em;
      pointer-events: auto;
      min-width: 160px;
      border: 1px solid var(--theme-section-border);
    }

    /* UPDATED: Custom Cluster Markers - Now match Site Types icons style */
    .custom-cluster {
      background: #FFD166;
      border: 2px solid white;
      border-radius: 50%;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      color: white;
      font-weight: 800;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      font-size: 8px;
      line-height: 1.1;
      padding: 2px;
      text-align: center;
      letter-spacing: -0.5px;
    }

    .custom-cluster:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    /* UPDATED: Cluster colors to match Site Types - WABS and WWPS updated */
    .cluster-wtnk {
      background: #36A2EB;
    }

    .cluster-wwps {
      background: #FF6384; /* Pink/red - kept same */
    }

    .cluster-wwtp {
      background: #FFCE56;
      color: #0d1117;
    }

    .cluster-wfls {
      background: #4BC0C0;
    }

    .cluster-wpus {
      background: #9966FF;
    }

    .cluster-wtrp {
      background: #FF9F40;
    }

    .cluster-wabs {
      background: #00D4AA; /* Changed to teal/cyan for clear distinction */
    }

    .cluster-mixed {
      background: linear-gradient(135deg, #FF9E6D 0%, #00A8FF 50%, #FF5252 100%);
      background-size: 200% 200%;
      animation: gradientShift 3s infinite alternate;
    }

    /* Individual Marker Styles - UPDATED: ONLY SHOW SITE TYPE ABBREVIATION */
    .site-type-marker {
      background: #36A2EB;
      border: 2px solid white;
      border-radius: 50%;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      color: white;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      font-size: 9px;
      line-height: 1;
      letter-spacing: -0.3px;
    }

    .site-type-marker:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
      z-index: 1000;
    }

    /* UPDATED: WABS and WWPS colors for better differentiation */
    .site-type-marker.wtnk {
      background: #36A2EB;
    }
    .site-type-marker.wwps {
      background: #FF6384; /* Pink/red - kept same */
    }
    .site-type-marker.wwtp {
      background: #FFCE56;
      color: #0d1117;
    }
    .site-type-marker.wfls {
      background: #4BC0C0;
    }
    .site-type-marker.wpus {
      background: #9966FF;
    }
    .site-type-marker.wtrp {
      background: #FF9F40;
    }
    .site-type-marker.wabs {
      background: #00D4AA; /* Changed to teal/cyan for clear distinction */
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }

    ::-webkit-scrollbar-track {
      background: var(--theme-scrollbar-track);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--theme-scrollbar-thumb);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-blue);
    }

    /* Custom Leaflet controls */
    .leaflet-control-container .leaflet-top.leaflet-right {
      top: 80px;
    }

    /* Responsive adjustments */
    @media (max-width: 1200px) {
      .panels-container {
        width: 320px;
      }
      .control-panel {
        width: 320px;
      }
      .equipment-panel {
        width: 400px; /* Adjusted */
      }
      .equipment-panel:not(.hidden) ~ .equipment-toggle {
        right: calc(400px + 30px);
      }
      .site-name-display {
        max-width: 400px;
      }
      .site-name-container {
        min-width: 250px;
        padding: 10px 20px;
      }
      .site-name-container h2 {
        font-size: 1.3em;
      }
      .bottom-panel {
        width: 700px;
      }
      .city-tour-controls {
        flex-wrap: wrap;
      }
      .tour-speed-control {
        min-width: 180px;
      }
    }

    @media (max-width: 992px) {
      .distribution-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      .bottom-panel {
        width: 600px;
      }
      .city-tour-controls {
        flex-direction: column;
        align-items: flex-start;
      }
      .city-tour-buttons {
        width: 100%;
        justify-content: center;
      }
      .tour-speed-control {
        width: 100%;
      }
    }

    @media (max-width: 768px) {
      .panels-container {
        width: 280px;
      }
      .control-panel {
        width: 280px;
      }
      .equipment-panel {
        width: calc(100% - 40px);
        height: 600px;
        right: 20px;
      }
      .equipment-panel:not(.hidden) ~ .equipment-toggle {
        right: 20px;
        top: 20px;
        transform: none;
      }
      .stats-summary {
        grid-template-columns: 1fr;
      }
      .site-name-display {
        width: calc(100% - 40px);
        top: 15px;
      }
      .site-name-container {
        min-width: auto;
        width: 100%;
        padding: 10px 15px;
      }
      .site-name-container h2 {
        font-size: 1.1em;
        gap: 8px;
      }
      .bottom-panel {
        width: calc(100% - 40px);
      }
      .map-view-content {
        flex-direction: column;
        align-items: flex-start;
      }
      .map-view-left, .map-view-right {
        width: 100%;
        justify-content: center;
      }
      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      .chart-section {
        flex: 0 0 300px;
      }
      .chart-container-wrapper {
        width: 280px;
        height: 280px;
        padding: 12px;
      }
      #equipmentChart {
        width: 256px !important;
        height: 256px !important;
      }
      .distribution-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      .quick-actions {
        grid-template-columns: 1fr;
      }
      .scale-indicator {
        bottom: 140px;
        left: 10px;
        font-size: 0.8em;
        min-width: 140px;
      }
      .zoom-level {
        bottom: 140px;
        right: 10px;
        font-size: 0.8em;
      }
      .theme-toggle {
        padding: 6px 10px;
        font-size: 0.75em;
      }
    }

    @media (max-width: 576px) {
      .distribution-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .bottom-panel-tab {
        padding: 10px 15px;
        font-size: 0.8em;
      }
      .tour-button {
        padding: 8px 15px;
        min-width: 80px;
        font-size: 0.8em;
      }
      .tour-speed-control label {
        font-size: 0.8em;
      }
      /* Removed city tour notification responsive styles */
      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 480px) {
      .distribution-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .equipment-panel {
        width: calc(100% - 20px);
        right: 10px;
      }
      .site-name-container h2 {
        font-size: 1em;
      }
      .layer-option {
        padding: 5px 8px;
        font-size: 0.7em;
      }
      .chart-container-wrapper {
        width: 260px;
        height: 260px;
      }
      #equipmentChart {
        width: 236px !important;
        height: 236px !important;
      }
      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      .distribution-item {
        min-height: 75px;
        padding: 8px 4px;
      }
      .distribution-icon {
        width: 28px;
        height: 28px;
        font-size: 12px;
      }
      .theme-toggle span {
        display: none;
      }
      .theme-toggle {
        padding: 8px;
        justify-content: center;
        width: 40px;
      }
      .bottom-panel-tabs {
        flex-direction: column;
      }
      .bottom-panel-tab {
        padding: 8px 12px;
        justify-content: flex-start;
      }
      .tour-button span {
        display: none;
      }
      .tour-button {
        min-width: 60px;
        justify-content: center;
      }
      .tour-button i {
        margin: 0;
      }
      .tour-speed-control {
        min-width: 150px;
      }
    }

    @media (max-width: 380px) {
      .distribution-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .chart-container-wrapper {
        width: 240px;
        height: 240px;
      }
      #equipmentChart {
        width: 216px !important;
        height: 216px !important;
      }
    }
  </style>
</head>

<body>

<div id="map"></div>

<!-- Panels Container -->
<div class="panels-container">
  <!-- Left Control Panel -->
  <div class="control-panel" id="controlPanel">
    <!-- Tab Navigation -->
    <div class="panel-tabs">
      <button class="panel-tab active" id="siteTab" onclick="switchTab('site')">
        <i class="fas fa-building"></i> Site Information
      </button>
      <button class="panel-tab" id="assetTab" onclick="switchTab('asset')">
        <i class="fas fa-water"></i> Asset Information
      </button>
    </div>

    <div class="panel-header">
      <h2><i class="fas fa-water"></i> Facilities Site</h2>
      <button class="close-panel" onclick="toggleDashboard()">Ã—</button>
    </div>

    <!-- Site Information Dashboard Content -->
    <div class="dashboard-content" id="siteDashboardContent">
      <!-- UPDATED: 6 stat cards in 2 rows Ã— 3 columns with specified order -->
      <div class="stats-grid site-stats">
        <!-- Row 1: Total Sites, Working, Out of Service -->
        <div class="stat-card total" onclick="filterSiteByStatus('all')">
          <h3><i class="fas fa-city"></i> Total Sites</h3>
          <div class="stat-value" id="totalSites">0</div>
          <div class="stat-percent" id="totalSitePercent">100%</div>
        </div>
        <div class="stat-card working" onclick="filterSiteByStatus('WORKING')">
          <h3><i class="fas fa-check-circle"></i> Working</h3>
          <div class="stat-value" id="workingSites">0</div>
          <div class="stat-percent" id="workingSitePercent">0%</div>
        </div>
        <div class="stat-card out-of-service" onclick="filterSiteByStatus('OUT_OF_SERVICE')">
          <h3><i class="fas fa-times-circle"></i> Out of Service</h3>
          <div class="stat-value" id="outOfServiceSites">0</div>
          <div class="stat-percent" id="outOfServiceSitePercent">0%</div>
        </div>
        <!-- Row 2: Standby, Transfer, CWIP -->
        <div class="stat-card standby" onclick="filterSiteByStatus('STANDBY')">
          <h3><i class="fas fa-pause-circle"></i> Standby</h3>
          <div class="stat-value" id="standbySites">0</div>
          <div class="stat-percent" id="standbySitePercent">0%</div>
        </div>
        <div class="stat-card transfer" onclick="filterSiteByStatus('TRANSFER')">
          <h3><i class="fas fa-exchange-alt"></i> Transfer</h3>
          <div class="stat-value" id="transferSites">0</div>
          <div class="stat-percent" id="transferSitePercent">0%</div>
        </div>
        <div class="stat-card cwip" onclick="filterSiteByStatus('CWIP')">
          <h3><i class="fas fa-tools"></i> CWIP</h3>
          <div class="stat-value" id="cwipSites">0</div>
          <div class="stat-percent" id="cwipSitePercent">0%</div>
        </div>
      </div>

      <!-- Site Information Filters -->
      <div class="filters-section">
        <h3><i class="fas fa-filter"></i> Filters</h3>
        
        <!-- City Filter -->
        <div class="filter-group">
          <label for="siteCityFilter"><i class="fas fa-city"></i> City</label>
          <select id="siteCityFilter" onchange="filterSiteByCity()">
            <option value="all">All Cities</option>
          </select>
        </div>

        <!-- Site Type Filter (replaces Site Name L3) -->
        <div class="filter-group">
          <label for="siteTypeFilter"><i class="fas fa-building"></i> Site Type</label>
          <select id="siteTypeFilter" onchange="filterSiteByType()">
            <option value="all">All Site Types</option>
          </select>
        </div>

        <!-- Site Status Filter (replaces Condition Filter) -->
        <div class="filter-group">
          <label for="siteStatusFilter"><i class="fas fa-tachometer-alt"></i> Site Status</label>
          <select id="siteStatusFilter" onchange="applySiteFilters()">
            <option value="all">All Statuses</option>
          </select>
        </div>

        <!-- Chart Type Filter -->
        <div class="filter-group">
          <label for="siteChartTypeFilter"><i class="fas fa-chart-pie"></i> Chart Type</label>
          <select id="siteChartTypeFilter" onchange="changeSiteChartType()">
            <option value="siteType">Site Type Distribution</option>
            <option value="siteStatus">Site Status Distribution</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="siteLocationGrouping"><i class="fas fa-layer-group"></i> Group By Location</label>
          <select id="siteLocationGrouping" onchange="changeSiteVisualizationMode()">
            <option value="cluster">Cluster Markers</option>
            <option value="individual">Individual Markers</option>
            <option value="single">Single Marker per Location</option>
            <option value="spider">Spread Out at Same Location</option>
            <option value="heatmap">Heatmap View</option>
          </select>
        </div>
      </div>

      <!-- Site Health Indicator -->
      <div class="health-indicator" id="siteHealthIndicator">
        <h4><i class="fas fa-heartbeat"></i> Site Health</h4>
        <div class="health-bar">
          <div class="health-fill" id="siteHealthFill" style="width: 75%"></div>
        </div>
        <div class="health-stats">
          <span class="health-label">Overall Score</span>
          <span class="health-score" id="siteHealthScore">75%</span>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
          <div class="quick-action critical" onclick="filterSiteByStatus('OUT_OF_SERVICE')">
            <i class="fas fa-exclamation-triangle"></i> View Out of Service
          </div>
          <div class="quick-action working" onclick="filterSiteByStatus('WORKING')">
            <i class="fas fa-check-circle"></i> View Working
          </div>
        </div>
      </div>
    </div>

    <!-- Asset Information Dashboard Content (Hidden by default) -->
    <div class="dashboard-content" id="assetDashboardContent" style="display: none;">
      <!-- UPDATED: 3 stat cards in single row -->
      <div class="stats-grid">
        <div class="stat-card total" onclick="filterByType('all')">
          <h3><i class="fas fa-boxes"></i> Total Assets</h3>
          <div class="stat-value" id="totalAssets">0</div>
          <div class="stat-percent" id="totalPercent">100%</div>
        </div>
        <div class="stat-card working" onclick="filterByStatus('working')">
          <h3><i class="fas fa-check-circle"></i> Working</h3>
          <div class="stat-value" id="workingAssets">0</div>
          <div class="stat-percent" id="workingPercent">0%</div>
        </div>
        <div class="stat-card not-working" onclick="filterByStatus('not-working')">
          <h3><i class="fas fa-times-circle"></i> Not Working</h3>
          <div class="stat-value" id="notWorkingAssets">0</div>
          <div class="stat-percent" id="notWorkingPercent">0%</div>
        </div>
      </div>

      <!-- Asset Information Filters -->
      <div class="filters-section">
        <h3><i class="fas fa-filter"></i> Filters</h3>
        
        <!-- City Filter -->
        <div class="filter-group">
          <label for="cityFilter"><i class="fas fa-city"></i> City</label>
          <select id="cityFilter" onchange="filterByCity()">
            <option value="all">All Cities</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="siteFilter"><i class="fas fa-map-marker-alt"></i> Site Name L3</label>
          <select id="siteFilter" onchange="filterBySite()">
            <option value="all">All Sites</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="conditionFilter"><i class="fas fa-tachometer-alt"></i> Condition</label>
          <select id="conditionFilter" onchange="applyFilters()">
            <option value="all">All Conditions</option>
          </select>
        </div>

        <!-- NEW: Chart Type Filter -->
        <div class="filter-group">
          <label for="chartTypeFilter"><i class="fas fa-chart-pie"></i> Chart Type</label>
          <select id="chartTypeFilter" onchange="changeChartType()">
            <option value="siteType">Site Type Distribution</option>
            <option value="condition">Condition Distribution</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="locationGrouping"><i class="fas fa-layer-group"></i> Group By Location</label>
          <select id="locationGrouping" onchange="changeVisualizationMode()">
            <option value="cluster">Cluster Markers</option>
            <option value="individual">Individual Markers</option>
            <option value="single">Single Marker per Location</option>
            <option value="spider">Spread Out at Same Location</option>
            <option value="heatmap">Heatmap View</option>
          </select>
        </div>
      </div>

      <!-- Asset Health Indicator -->
      <div class="health-indicator" id="assetHealthIndicator">
        <h4><i class="fas fa-heartbeat"></i> Site Health</h4>
        <div class="health-bar">
          <div class="health-fill" id="healthFill" style="width: 75%"></div>
        </div>
        <div class="health-stats">
          <span class="health-label">Overall Score</span>
          <span class="health-score" id="healthScore">75%</span>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
          <div class="quick-action critical" onclick="filterByStatus('not-working')">
            <i class="fas fa-exclamation-triangle"></i> View Critical
          </div>
          <div class="quick-action working" onclick="filterByStatus('working')">
            <i class="fas fa-check-circle"></i> View Working
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- REDESIGNED Equipment Panel - NOW CITY OVERVIEW -->
<div class="equipment-panel hidden" id="equipmentPanel">
  <div class="equipment-header">
    <div>
      <h3><i class="fas fa-city" id="panelIcon"></i> <span id="panelTitle">City Overview</span></h3>
    </div>
    <button class="close-panel" onclick="toggleEquipmentPanel()">Ã—</button>
  </div>
  
  <div class="equipment-content">
    <!-- City/Site Info -->
    <div class="site-name-highlight" id="citySiteName">All Cities</div>
    
    <!-- Stats Summary -->
    <div class="stats-summary" id="cityStatsSummary">
      <div class="summary-card total-equipment">
        <h4><i class="fas fa-building"></i> <span id="distributionTypeLabel">Site Types</span></h4>
        <div class="summary-value" id="distributionTypesCount">0</div>
        <div class="summary-label" id="distributionTypeSubLabel">Total Site Types</div>
      </div>
      
      <div class="summary-card critical-equipment">
        <h4><i class="fas fa-map-marker-alt"></i> Total Sites</h4>
        <div class="summary-value" id="totalSitesCount">0</div>
        <div class="summary-label">All Locations</div>
      </div>
    </div>
    
    <!-- VISUALLY APPEALING Doughnut Chart Section - OPTIMIZED SIZE -->
    <div class="chart-section">
      <h4><i class="fas fa-chart-pie" id="chartIcon"></i> <span id="chartTitle">Site Type Distribution</span></h4>
      <div class="chart-container-wrapper">
        <canvas id="equipmentChart"></canvas>
      </div>
    </div>
    
    <!-- Distribution Container (at bottom) - Now handles both Site Types and Conditions -->
    <div class="distribution-container">
      <h4><i class="fas fa-layer-group" id="distributionIcon"></i> <span id="distributionTitle">Site Types</span> in <span id="currentCityName">All Cities</span></h4>
      <div class="distribution-grid" id="distributionGrid">
        <!-- Dynamic distribution items will be added here -->
      </div>
    </div>
  </div>
</div>

<!-- Dashboard Toggle Button -->
<div class="dashboard-toggle" id="dashboardToggle" onclick="toggleDashboard()">
  <i class="fas fa-chart-line"></i>
</div>

<!-- Equipment Toggle Button -->
<div class="equipment-toggle" id="equipmentToggle" onclick="toggleEquipmentPanel()">
  <i class="fas fa-city"></i>
</div>

<!-- Site Name Display (Replaces Search Box) -->
<div class="site-name-display" id="siteNameDisplay">
  <div class="site-name-container" id="siteNameContainer">
    <h2><i class="fas fa-map-marker-alt"></i> <span id="currentSiteName">All Sites</span></h2>
    <div class="site-count" id="siteCount">0 assets</div>
  </div>
</div>

<!-- NEW: Bottom Panel with Tabs -->
<div class="bottom-panel" id="bottomPanel">
  <div class="bottom-panel-tabs">
    <button class="bottom-panel-tab active" id="mapViewTab" onclick="switchBottomTab('mapView')">
      <i class="fas fa-layer-group"></i> Map View
    </button>
    <button class="bottom-panel-tab" id="cityTourTab" onclick="switchBottomTab('cityTour')">
      <i class="fas fa-map-marked-alt"></i> City Tour Animation
    </button>
  </div>
  
  <div class="bottom-panel-content">
    <!-- Map View Tab Content -->
    <div id="mapViewContent" class="tab-content active">
      <div class="map-view-content">
        <div class="map-view-left">
          <h4><i class="fas fa-layer-group"></i> Map View</h4>
          <div class="layer-options">
            <div class="layer-option active" onclick="changeMapLayer('street')">
              <i class="fas fa-road"></i> Street
            </div>
            <div class="layer-option" onclick="changeMapLayer('imagery')">
              <i class="fas fa-satellite"></i> Imagery
            </div>
            <div class="layer-option" onclick="changeMapLayer('hybrid')">
              <i class="fas fa-map"></i> Hybrid
            </div>
          </div>
        </div>
        <div class="map-view-right">
          <div class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
            <i class="fas fa-moon"></i> <span>Dark Theme</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- City Tour Animation Tab Content -->
    <div id="cityTourContent" class="tab-content">
      <div class="city-tour-content">
        <div class="city-tour-header">
          <h4><i class="fas fa-map-marked-alt"></i> City Tour Animation</h4>
        </div>
        
        <div class="city-tour-controls">
          <div class="city-tour-buttons">
            <button class="tour-button play" id="playTourBtn" onclick="startCityTour()">
              <i class="fas fa-play"></i> <span>Start Tour</span>
            </button>
            <button class="tour-button pause" id="pauseTourBtn" onclick="pauseCityTour()" disabled>
              <i class="fas fa-pause"></i> <span>Pause</span>
            </button>
            <button class="tour-button stop" id="stopTourBtn" onclick="stopCityTour()" disabled>
              <i class="fas fa-stop"></i> <span>Stop</span>
            </button>
          </div>
          
          <div class="tour-speed-control">
            <label for="tourSpeed"><i class="fas fa-tachometer-alt"></i> Speed:</label>
            <input type="range" min="1000" max="10000" value="4000" step="1000" class="tour-speed-slider" id="tourSpeed" oninput="updateTourSpeed()">
            <span class="tour-speed-value" id="tourSpeedValue">4s</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- REMOVED: City Tour Notification Display - This is the popup we want to remove -->

<!-- Scale Indicator -->
<div class="scale-indicator" id="scaleIndicator">
  Scale: 1:<span id="currentScale">100,000</span>
</div>

<!-- Zoom Level Indicator -->
<div class="zoom-level" id="zoomLevel">
  Zoom Level: <span id="currentZoom">12</span>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
  // Global variables
  let map;
  let markerCluster;
  let individualMarkers = [];
  let allAssets = [];
  let allSites = [];
  let filteredAssets = [];
  let filteredSites = [];
  let currentMarkers = [];
  let currentVisualization = 'cluster';
  let heatLayer = null;
  let currentSite = null;
  let currentCity = null;
  let siteStats = {};
  let cityStats = {};
  let siteCityStats = {};
  let currentZoom = 12;
  let equipmentChart = null;
  let currentMapLayer = 'street';
  let mapLayers = {};
  let siteTypeColorMap = {};
  let conditionColorMap = {};
  let siteStatusColorMap = {};
  let currentChartType = 'siteType'; // 'siteType' or 'condition'
  let currentSiteChartType = 'siteType'; // 'siteType' or 'siteStatus'
  let isDarkTheme = false;
  let currentTab = 'site'; // 'site' or 'asset'
  
  // City Tour Animation Variables
  let cityTourInterval = null;
  let currentTourCityIndex = -1;
  let tourCities = [];
  let tourIsPlaying = false;
  let tourSpeed = 4000; // Default 4 seconds
  let tourData = {}; // Store city-specific data for the tour
  
  // City coordinates mapping (from your requirements)
  const cityCoordinates = {
    'AL AIS': { lat: 25.06798, lng: 38.12393 },
    'AL HENAKIYAH': { lat: 24.91679, lng: 40.52268 },
    'AL MADINAH': { lat: 24.46948, lng: 39.61090 },
    'AL MAHD': { lat: 23.49765, lng: 40.87637 },
    'AL ULA': { lat: 26.58120, lng: 37.95454 },
    'BADR': { lat: 23.79030, lng: 38.78112 },
    'KHAYBAR': { lat: 25.68919, lng: 39.29349 },
    'WADI AL FARA': { lat: 23.80260, lng: 39.65130 },
    'YANBU': { lat: 24.09544, lng: 38.20134 }
  };
  
  // Enhanced color scheme for professional appearance
  const conditionColors = {
    'EXCELLENT': '#00FF9D',      // Bright Emerald Green
    'VERY GOOD': '#00C896',      // Vibrant Green
    'GOOD': '#00A8FF',           // Electric Blue
    'NEW': '#9D4EDD',            // Royal Purple
    'FAIR': '#FFD166',           // Golden Yellow
    'POOR': '#FF9E6D',           // Burnt Orange
    'CRITICAL': '#FF5252',       // Fire Engine Red
    'UNKNOWN': '#6D6A75'         // Slate Gray
  };
  
  // Site Status colors
  const siteStatusColors = {
    'WORKING': '#00b894',        // Success Green
    'STANDBY': '#FFD166',        // Golden Yellow
    'OUT_OF_SERVICE': '#FF9E6D', // Burnt Orange
    'CWIP': '#9D4EDD',           // Royal Purple
    'TRANSFER': '#00A8FF',       // Electric Blue
    'UNKNOWN': '#6D6A75'         // Slate Gray
  };
  
  // Site Type colors for pie chart - UPDATED: WABS changed to teal/cyan (#00D4AA) for better distinction
  const siteTypeColors = [
    '#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0', // WTNK, WWPS, WWTP, WFLS
    '#9966FF', '#FF9F40', '#00D4AA', '#00B894', // WPUS, WTRP, WABS (updated), extra
    '#95A5A6', '#9D4EDD', '#00FF9D', '#00C896'
  ];

  // Site Type abbreviation mapping
  const siteTypeAbbreviations = {
    'POTABLE WATER STORAGE TANKS (WTNK)': 'WTNK',
    'WASTE WATER PUMPING STATION (WWPS)': 'WWPS',
    'WASTE WATER TREATMENT PLANT (WWTP)': 'WWTP',
    'WATER FILLING STATION (WFLS)': 'WFLS',
    'WATER PUMPING STATION (WPUS)': 'WPUS',
    'WATER TREATMENT PLANT (WTRP)': 'WTRP',
    'WELL ABSTRACTION (WABS)': 'WABS'
  };

  // Site Type to CSS class mapping
  const siteTypeToClass = {
    'POTABLE WATER STORAGE TANKS (WTNK)': 'wtnk',
    'WASTE WATER PUMPING STATION (WWPS)': 'wwps',
    'WASTE WATER TREATMENT PLANT (WWTP)': 'wwtp',
    'WATER FILLING STATION (WFLS)': 'wfls',
    'WATER PUMPING STATION (WPUS)': 'wpus',
    'WATER TREATMENT PLANT (WTRP)': 'wtrp',
    'WELL ABSTRACTION (WABS)': 'wabs'
  };
  
  // Initialize map
  function initMap() {
    map = L.map('map').setView([24.50, 39.65], 12);
    
    // Define map layers - Using same layers for both themes
    mapLayers = {
      street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors',
        name: 'Street View'
      }),
      imagery: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: 'Â© Esri, Earthstar Geographics',
        name: 'Satellite Imagery'
      }),
      hybrid: L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: 'Â© Google Maps',
        name: 'Hybrid View'
      })
    };
    
    // Add default layer
    mapLayers.street.addTo(map);
    
    // Initialize marker cluster with custom styling - UPDATED: Now matches Site Types icons style
    markerCluster = L.markerClusterGroup({
      maxClusterRadius: function(zoom) {
        if (zoom >= 15) return 8;
        if (zoom >= 12) return 15;
        return 30;
      },
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: true,
      zoomToBoundsOnClick: true,
      disableClusteringAtZoom: 17,
      iconCreateFunction: function(cluster) {
        const count = cluster.getChildCount();
        
        // Analyze cluster site types
        const siteTypes = {};
        let dominantSiteType = '';
        let maxCount = 0;
        let siteTypeClass = '';
        
        cluster.getAllChildMarkers().forEach(marker => {
          if (marker.options.site || marker.options.asset) {
            let siteType = '';
            if (marker.options.site) {
              siteType = marker.options.site.siteType || '';
            } else if (marker.options.asset) {
              siteType = marker.options.asset.siteTypeL2 || '';
            }
            
            const abbrev = getSiteTypeAbbreviation(siteType);
            const typeClass = getSiteTypeClass(siteType);
            
            if (!siteTypes[abbrev]) {
              siteTypes[abbrev] = { count: 0, class: typeClass };
            }
            siteTypes[abbrev].count++;
            
            if (siteTypes[abbrev].count > maxCount) {
              maxCount = siteTypes[abbrev].count;
              dominantSiteType = abbrev;
              siteTypeClass = typeClass;
            }
          }
        });
        
        // Determine cluster color based on dominant site type
        let backgroundColor = '#FFD166';
        let textColor = '#0d1117';
        
        // UPDATED: Use same color logic as individual markers and distribution items
        switch(siteTypeClass) {
          case 'wtnk': backgroundColor = '#36A2EB'; textColor = 'white'; break;
          case 'wwps': backgroundColor = '#FF6384'; textColor = 'white'; break;
          case 'wwtp': backgroundColor = '#FFCE56'; textColor = '#0d1117'; break;
          case 'wfls': backgroundColor = '#4BC0C0'; textColor = 'white'; break;
          case 'wpus': backgroundColor = '#9966FF'; textColor = 'white'; break;
          case 'wtrp': backgroundColor = '#FF9F40'; textColor = 'white'; break;
          case 'wabs': backgroundColor = '#00D4AA'; textColor = '#0d1117'; break; // Updated to teal/cyan
          default: backgroundColor = '#FFD166'; textColor = '#0d1117';
        }
        
        // Calculate size based on count
        let size = 20;
        let fontSize = 8;
        
        if (count < 10) {
          size = 24;
          fontSize = 9;
        } else if (count < 50) {
          size = 28;
          fontSize = 10;
        } else if (count < 100) {
          size = 32;
          fontSize = 11;
        } else {
          size = 36;
          fontSize = 12;
        }
        
        // UPDATED: Cluster marker now matches Site Types icons style - circular with icon and abbreviation
        return L.divIcon({
          html: `<div class="custom-cluster cluster-${siteTypeClass}" style="width: ${size}px; height: ${size}px; font-size: ${fontSize}px; background: ${backgroundColor}; color: ${textColor};">
                  <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                    <i class="fas fa-building" style="font-size: ${fontSize * 0.9}px; margin-bottom: 2px;"></i>
                    <div style="font-weight: bold; font-size: ${fontSize * 0.7}px; line-height: 1;">${dominantSiteType || 'MIX'}</div>
                  </div>
                </div>`,
          className: 'custom-cluster-icon',
          iconSize: L.point(size, size),
          iconAnchor: L.point(size/2, size/2)
        });
      }
    });
    
    // Track zoom level
    map.on('zoomend', function() {
      currentZoom = map.getZoom();
      document.getElementById('currentZoom').textContent = currentZoom;
      updateScaleIndicator();
    });
    
    map.on('moveend', updateScaleIndicator);
    
    document.getElementById('currentZoom').textContent = currentZoom;
    updateScaleIndicator();
  }
  
  // ===========================================
  // BOTTOM PANEL TAB SWITCHING
  // ===========================================
  
  // Switch bottom panel tabs
  function switchBottomTab(tab) {
    const mapViewTab = document.getElementById('mapViewTab');
    const cityTourTab = document.getElementById('cityTourTab');
    const mapViewContent = document.getElementById('mapViewContent');
    const cityTourContent = document.getElementById('cityTourContent');
    
    // Update tab buttons
    mapViewTab.classList.remove('active');
    cityTourTab.classList.remove('active');
    
    // Hide all content
    mapViewContent.classList.remove('active');
    cityTourContent.classList.remove('active');
    
    // Show selected content
    if (tab === 'mapView') {
      mapViewTab.classList.add('active');
      mapViewContent.classList.add('active');
    } else if (tab === 'cityTour') {
      cityTourTab.classList.add('active');
      cityTourContent.classList.add('active');
    }
  }
  
  // ===========================================
  // CITY TOUR ANIMATION FUNCTIONS
  // ===========================================
  
  // Initialize city tour data
  function initCityTour() {
    // Extract unique cities from the current dataset
    tourCities = [];
    tourData = {};
    
    if (currentTab === 'site') {
      // Get unique cities from sites
      tourCities = [...new Set(allSites.map(s => s.city))].sort();
      
      // Prepare city data
      tourCities.forEach(city => {
        const citySites = allSites.filter(s => s.city === city);
        tourData[city] = {
          sites: citySites,
          assets: [], // Sites tab doesn't have assets
          coordinates: calculateCityBounds(citySites)
        };
      });
    } else {
      // Get unique cities from assets
      tourCities = [...new Set(allAssets.map(a => a.city))].sort();
      
      // Prepare city data
      tourCities.forEach(city => {
        const cityAssets = allAssets.filter(a => a.city === city);
        tourData[city] = {
          sites: [],
          assets: cityAssets,
          coordinates: calculateCityBounds(cityAssets)
        };
      });
    }
    
    // Update tour UI
    updateTourUI();
    
    console.log(`City tour initialized with ${tourCities.length} cities`);
    return tourCities.length > 0;
  }
  
  // Calculate city bounds from points
  function calculateCityBounds(items) {
    if (!items || items.length === 0) {
      return { center: [24.50, 39.65], bounds: null };
    }
    
    // Calculate center point
    const totalLat = items.reduce((sum, item) => sum + item.latitude, 0);
    const totalLng = items.reduce((sum, item) => sum + item.longitude, 0);
    const center = [totalLat / items.length, totalLng / items.length];
    
    // Calculate bounds
    const bounds = L.latLngBounds(items.map(item => [item.latitude, item.longitude]));
    
    return { center, bounds };
  }
  
  // Start city tour
  function startCityTour() {
    if (tourIsPlaying) return;
    
    if (tourCities.length === 0 && !initCityTour()) {
      showNotification('No cities found for tour. Please load data first.', 'error');
      return;
    }
    
    // If we're at the end, restart from beginning
    if (currentTourCityIndex >= tourCities.length - 1) {
      currentTourCityIndex = -1;
    }
    
    tourIsPlaying = true;
    updateTourButtons();
    
    // REMOVED: Hide tour notification (popup is removed entirely)
    
    // Start the interval
    cityTourInterval = setInterval(nextCity, tourSpeed);
    
    // Immediately go to first city if not already on one
    if (currentTourCityIndex < 0) {
      nextCity();
    } else {
      // Show current city
      showCityInTour(currentTourCityIndex);
    }
    
    showNotification('City tour started', 'success');
  }
  
  // Pause city tour
  function pauseCityTour() {
    if (!tourIsPlaying) return;
    
    tourIsPlaying = false;
    if (cityTourInterval) {
      clearInterval(cityTourInterval);
      cityTourInterval = null;
    }
    
    updateTourButtons();
    showNotification('City tour paused', 'info');
  }
  
  // Stop city tour
  function stopCityTour() {
    tourIsPlaying = false;
    if (cityTourInterval) {
      clearInterval(cityTourInterval);
      cityTourInterval = null;
    }
    
    currentTourCityIndex = -1;
    updateTourButtons();
    
    // Reset to show all data
    if (currentTab === 'site') {
      document.getElementById('siteCityFilter').value = 'all';
      filterSiteByCity();
    } else {
      document.getElementById('cityFilter').value = 'all';
      filterByCity();
    }
    
    // REMOVED: Hide tour notification (popup is removed entirely)
    
    showNotification('City tour stopped', 'info');
  }
  
  // Go to next city in tour
  function nextCity() {
    if (tourCities.length === 0) return;
    
    currentTourCityIndex++;
    if (currentTourCityIndex >= tourCities.length) {
      currentTourCityIndex = 0; // Loop back to start
    }
    
    showCityInTour(currentTourCityIndex);
  }
  
  // Go to previous city in tour
  function previousCity() {
    if (tourCities.length === 0) return;
    
    currentTourCityIndex--;
    if (currentTourCityIndex < 0) {
      currentTourCityIndex = tourCities.length - 1; // Loop to end
    }
    
    showCityInTour(currentTourCityIndex);
  }
  
  // Show a specific city in the tour - REMOVED: popup notification
  function showCityInTour(cityIndex) {
    if (cityIndex < 0 || cityIndex >= tourCities.length) return;
    
    const city = tourCities[cityIndex];
    const cityData = tourData[city];
    
    // Update filters to show only this city
    if (currentTab === 'site') {
      document.getElementById('siteCityFilter').value = city;
      filterSiteByCity();
    } else {
      document.getElementById('cityFilter').value = city;
      filterByCity();
    }
    
    // Fly to city with smooth animation
    if (cityData && cityData.coordinates) {
      const { center, bounds } = cityData.coordinates;
      
      if (bounds) {
        // Fly to bounds with padding
        map.flyToBounds(bounds, {
          padding: [50, 50],
          duration: 1.5,
          easeLinearity: 0.25
        });
      } else if (center) {
        // Fallback to center point
        map.flyTo(center, 14, {
          duration: 1.5,
          easeLinearity: 0.25
        });
      }
    }
    
    // REMOVED: Show city notification (popup constraint: no center popup)
    // The popup has been completely removed from the application
  }
  
  // Update tour buttons state
  function updateTourButtons() {
    const playBtn = document.getElementById('playTourBtn');
    const pauseBtn = document.getElementById('pauseTourBtn');
    const stopBtn = document.getElementById('stopTourBtn');
    
    const hasCities = tourCities.length > 0;
    const isOnTour = currentTourCityIndex >= 0;
    
    // Enable/disable based on state
    playBtn.disabled = tourIsPlaying || !hasCities;
    pauseBtn.disabled = !tourIsPlaying;
    stopBtn.disabled = !isOnTour;
    
    // Update button text based on state
    if (tourIsPlaying) {
      playBtn.innerHTML = '<i class="fas fa-play"></i> <span>Playing...</span>';
      pauseBtn.innerHTML = '<i class="fas fa-pause"></i> <span>Pause</span>';
    } else {
      playBtn.innerHTML = '<i class="fas fa-play"></i> <span>Start Tour</span>';
      pauseBtn.innerHTML = '<i class="fas fa-pause"></i> <span>Pause</span>';
    }
  }
  
  // Update tour UI based on available cities
  function updateTourUI() {
    const hasCities = tourCities.length > 0;
    
    if (!hasCities) {
      // Grey out controls if no cities
      const cityTourTab = document.getElementById('cityTourTab');
      cityTourTab.style.opacity = '0.7';
      showNotification('No cities found in data. Load data to enable city tour.', 'info');
    } else {
      const cityTourTab = document.getElementById('cityTourTab');
      cityTourTab.style.opacity = '1';
      updateTourButtons();
    }
  }
  
  // Update tour speed
  function updateTourSpeed() {
    const speedSlider = document.getElementById('tourSpeed');
    const speedValue = document.getElementById('tourSpeedValue');
    
    tourSpeed = parseInt(speedSlider.value);
    speedValue.textContent = `${tourSpeed / 1000}s`;
    
    // Restart interval with new speed if tour is playing
    if (tourIsPlaying && cityTourInterval) {
      clearInterval(cityTourInterval);
      cityTourInterval = setInterval(nextCity, tourSpeed);
    }
  }
  
  // REMOVED: Show tour notification for current city
  // REMOVED: Hide tour notification
  
  // ===========================================
  // EXISTING FUNCTIONS (keeping for reference)
  // ===========================================
  
  // Tab Switching Function
  function switchTab(tab) {
    currentTab = tab;
    
    // Update tab buttons
    document.querySelectorAll('.panel-tab').forEach(tabBtn => {
      tabBtn.classList.remove('active');
    });
    
    if (tab === 'site') {
      document.getElementById('siteTab').classList.add('active');
      document.getElementById('siteDashboardContent').style.display = 'flex';
      document.getElementById('assetDashboardContent').style.display = 'none';
      
      // Update right panel for site data
      updateCityPanel();
      
      // Display site markers
      displaySiteMarkers();
      
      // Update site name display
      updateSiteNameDisplay();
      
      // Update health indicator
      updateSiteHealthIndicator();
    } else {
      document.getElementById('assetTab').classList.add('active');
      document.getElementById('assetDashboardContent').style.display = 'flex';
      document.getElementById('siteDashboardContent').style.display = 'none';
      
      // Update right panel for asset data
      updateCityPanel();
      
      // Display asset markers
      displayAssets();
      
      // Update site name display
      updateSiteNameDisplay();
      
      // Update health indicator
      updateHealthIndicator();
    }
    
    // Reinitialize city tour for current tab
    initCityTour();
  }
  
  // Theme Toggle Function
  function toggleTheme() {
    const body = document.body;
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = themeToggle.querySelector('i');
    const themeText = themeToggle.querySelector('span');
    
    isDarkTheme = !isDarkTheme;
    
    if (isDarkTheme) {
      body.classList.add('dark-theme');
      themeIcon.className = 'fas fa-sun';
      themeText.textContent = 'Light Theme';
    } else {
      body.classList.remove('dark-theme');
      themeIcon.className = 'fas fa-moon';
      themeText.textContent = 'Dark Theme';
    }
    
    // Save theme preference to localStorage
    localStorage.setItem('waterAssetsTheme', isDarkTheme ? 'dark' : 'light');
    
    // Update chart colors if chart exists
    if (equipmentChart) {
      updateCityPanel();
    }
  }
  
  // Load theme preference from localStorage
  function loadThemePreference() {
    const savedTheme = localStorage.getItem('waterAssetsTheme');
    const themeToggle = document.getElementById('themeToggle');
    
    if (savedTheme === 'dark') {
      isDarkTheme = true;
      document.body.classList.add('dark-theme');
      themeToggle.querySelector('i').className = 'fas fa-sun';
      themeToggle.querySelector('span').textContent = 'Light Theme';
    } else {
      isDarkTheme = false;
      themeToggle.querySelector('i').className = 'fas fa-moon';
      themeToggle.querySelector('span').textContent = 'Dark Theme';
    }
  }
  
  // Get site type abbreviation
  function getSiteTypeAbbreviation(siteType) {
    if (!siteType) return 'UNKN';
    
    // Check if siteType matches known patterns
    for (const [key, value] of Object.entries(siteTypeAbbreviations)) {
      if (siteType.toUpperCase().includes(key.split(' (')[0]) || 
          siteType.toUpperCase() === key) {
        return value;
      }
    }
    
    // Try to extract abbreviation from parentheses
    const match = siteType.match(/\(([A-Z]{4})\)/);
    if (match) {
      return match[1];
    }
    
    // Try to extract first 4 uppercase letters
    const uppercaseMatch = siteType.match(/([A-Z]{4})/);
    if (uppercaseMatch) {
      return uppercaseMatch[1];
    }
    
    // Return first 4 characters
    return siteType.substring(0, 4).toUpperCase();
  }
  
  // Get site type CSS class
  function getSiteTypeClass(siteType) {
    const abbrev = getSiteTypeAbbreviation(siteType).toLowerCase();
    return abbrev || 'unknown';
  }
  
  // Update scale indicator
  function updateScaleIndicator() {
    const center = map.getCenter();
    const zoom = map.getZoom();
    
    // Calculate approximate scale
    const worldCircumference = 40075016.686;
    const metersPerPixel = worldCircumference * Math.cos(center.lat * Math.PI / 180) / (256 * Math.pow(2, zoom));
    
    let scale;
    if (metersPerPixel < 1) {
      scale = Math.round(1 / metersPerPixel);
    } else {
      scale = Math.round(metersPerPixel);
    }
    
    const formattedScale = scale.toLocaleString();
    document.getElementById('currentScale').textContent = formattedScale;
  }
  
  // Change chart type for Asset Information
  function changeChartType() {
    currentChartType = document.getElementById('chartTypeFilter').value;
    if (currentTab === 'asset') {
      updateCityPanel();
    }
  }
  
  // Change chart type for Site Information
  function changeSiteChartType() {
    currentSiteChartType = document.getElementById('siteChartTypeFilter').value;
    if (currentTab === 'site') {
      updateCityPanel();
    }
  }
  
  // Change map layer
  function changeMapLayer(layerType) {
    if (mapLayers[currentMapLayer]) {
      map.removeLayer(mapLayers[currentMapLayer]);
    }
    
    if (mapLayers[layerType]) {
      mapLayers[layerType].addTo(map);
      currentMapLayer = layerType;
    }
    
    document.querySelectorAll('.layer-option').forEach(btn => {
      btn.classList.remove('active');
    });
    document.querySelector(`.layer-option[onclick*="${layerType}"]`).classList.add('active');
    
    showNotification(`Switched to ${layerType.charAt(0).toUpperCase() + layerType.slice(1)} view`, 'info');
  }
  
  // Update site name display
  function updateSiteNameDisplay() {
    if (currentTab === 'site') {
      const siteCityFilter = document.getElementById('siteCityFilter');
      const siteTypeFilter = document.getElementById('siteTypeFilter');
      const selectedCity = siteCityFilter.value;
      const selectedSiteType = siteTypeFilter.value;
      const siteNameContainer = document.getElementById('siteNameContainer');
      const siteCountElement = document.getElementById('siteCount');
      
      if (selectedCity === 'all' && selectedSiteType === 'all') {
        siteNameContainer.classList.remove('visible');
        setTimeout(() => {
          siteNameContainer.style.display = 'none';
        }, 300);
      } else {
        let displayName = '';
        if (selectedCity !== 'all') {
          const cityName = siteCityFilter.options[siteCityFilter.selectedIndex].text;
          const cityNameParts = cityName.split(' (');
          displayName = cityNameParts[0];
          if (selectedSiteType !== 'all') {
            const siteTypeName = siteTypeFilter.options[siteTypeFilter.selectedIndex].text;
            const siteTypeParts = siteTypeName.split(' (');
            displayName += ' - ' + siteTypeParts[0];
          }
        } else {
          const siteTypeName = siteTypeFilter.options[siteTypeFilter.selectedIndex].text;
          const siteTypeParts = siteTypeName.split(' (');
          displayName = siteTypeParts[0];
        }
        
        const siteCount = filteredSites.length;
        
        document.getElementById('currentSiteName').textContent = displayName;
        siteCountElement.textContent = `${siteCount} site${siteCount !== 1 ? 's' : ''}`;
        
        siteNameContainer.style.display = 'block';
        setTimeout(() => {
          siteNameContainer.classList.add('visible');
        }, 10);
      }
    } else {
      const siteFilter = document.getElementById('siteFilter');
      const cityFilter = document.getElementById('cityFilter');
      const selectedSite = siteFilter.value;
      const selectedCity = cityFilter.value;
      const siteNameContainer = document.getElementById('siteNameContainer');
      const siteCountElement = document.getElementById('siteCount');
      
      if (selectedSite === 'all' && selectedCity === 'all') {
        siteNameContainer.classList.remove('visible');
        setTimeout(() => {
          siteNameContainer.style.display = 'none';
        }, 300);
      } else {
        let displayName = '';
        if (selectedCity !== 'all') {
          const cityName = cityFilter.options[cityFilter.selectedIndex].text;
          const cityNameParts = cityName.split(' (');
          displayName = cityNameParts[0];
          if (selectedSite !== 'all') {
            const siteName = siteFilter.options[siteFilter.selectedIndex].text;
            const siteNameParts = siteName.split(' (');
            displayName += ' - ' + siteNameParts[0];
          }
        } else {
          const siteName = siteFilter.options[siteFilter.selectedIndex].text;
          const siteNameParts = siteName.split(' (');
          displayName = siteNameParts[0];
        }
        
        const assetCount = filteredAssets.length;
        
        document.getElementById('currentSiteName').textContent = displayName;
        siteCountElement.textContent = `${assetCount} asset${assetCount !== 1 ? 's' : ''}`;
        
        siteNameContainer.style.display = 'block';
        setTimeout(() => {
          siteNameContainer.classList.add('visible');
        }, 10);
      }
    }
  }
  
  // Update health indicator for Asset Information
  function updateHealthIndicator() {
    const selectedSite = document.getElementById('siteFilter').value;
    const selectedCity = document.getElementById('cityFilter').value;
    let assetsToCheck = allAssets;
    
    if (selectedSite !== 'all') {
      assetsToCheck = assetsToCheck.filter(a => a.siteNameL3 === selectedSite);
    } else if (selectedCity !== 'all') {
      assetsToCheck = assetsToCheck.filter(a => a.city === selectedCity);
    }
    
    if (assetsToCheck.length === 0) {
      document.getElementById('healthFill').style.width = '0%';
      document.getElementById('healthScore').textContent = '0%';
      return;
    }
    
    let score = 0;
    let totalWeight = 0;
    
    assetsToCheck.forEach(asset => {
      let weight = 0;
      switch(asset.condition) {
        case 'EXCELLENT': weight = 100; break;
        case 'VERY GOOD': weight = 85; break;
        case 'GOOD': weight = 70; break;
        case 'NEW': weight = 90; break;
        case 'FAIR': weight = 50; break;
        case 'POOR': weight = 30; break;
        case 'CRITICAL': weight = 10; break;
        default: weight = 50;
      }
      
      if (asset.working === 'YES') weight += 10;
      if (asset.inUse === 'YES') weight += 5;
      
      score += weight;
      totalWeight++;
    });
    
    const averageScore = Math.round(score / totalWeight);
    const clampedScore = Math.min(100, Math.max(0, averageScore));
    
    document.getElementById('healthFill').style.width = `${clampedScore}%`;
    document.getElementById('healthScore').textContent = `${clampedScore}%`;
    
    const healthScoreElement = document.getElementById('healthScore');
    if (clampedScore >= 80) {
      healthScoreElement.style.color = 'var(--success-green)';
    } else if (clampedScore >= 60) {
      healthScoreElement.style.color = 'var(--warning-orange)';
    } else {
      healthScoreElement.style.color = 'var(--danger-red)';
    }
  }
  
  // Update health indicator for Site Information
  function updateSiteHealthIndicator() {
    const selectedCity = document.getElementById('siteCityFilter').value;
    const selectedSiteType = document.getElementById('siteTypeFilter').value;
    const selectedStatus = document.getElementById('siteStatusFilter').value;
    
    let sitesToCheck = allSites;
    
    if (selectedCity !== 'all') {
      sitesToCheck = sitesToCheck.filter(s => s.city === selectedCity);
    }
    
    if (selectedSiteType !== 'all') {
      sitesToCheck = sitesToCheck.filter(s => s.siteType === selectedSiteType);
    }
    
    if (selectedStatus !== 'all') {
      sitesToCheck = sitesToCheck.filter(s => s.siteStatus === selectedStatus);
    }
    
    if (sitesToCheck.length === 0) {
      document.getElementById('siteHealthFill').style.width = '0%';
      document.getElementById('siteHealthScore').textContent = '0%';
      return;
    }
    
    let score = 0;
    let totalWeight = 0;
    
    sitesToCheck.forEach(site => {
      let weight = 0;
      switch(site.siteStatus) {
        case 'WORKING': weight = 100; break;
        case 'STANDBY': weight = 70; break;
        case 'OUT_OF_SERVICE': weight = 30; break;
        case 'CWIP': weight = 50; break;
        case 'TRANSFER': weight = 60; break;
        default: weight = 50;
      }
      
      score += weight;
      totalWeight++;
    });
    
    const averageScore = Math.round(score / totalWeight);
    const clampedScore = Math.min(100, Math.max(0, averageScore));
    
    document.getElementById('siteHealthFill').style.width = `${clampedScore}%`;
    document.getElementById('siteHealthScore').textContent = `${clampedScore}%`;
    
    const healthScoreElement = document.getElementById('siteHealthScore');
    if (clampedScore >= 80) {
      healthScoreElement.style.color = 'var(--success-green)';
    } else if (clampedScore >= 60) {
      healthScoreElement.style.color = 'var(--warning-orange)';
    } else {
      healthScoreElement.style.color = 'var(--danger-red)';
    }
  }
  
  // Toggle dashboard visibility
  function toggleDashboard() {
    const panel = document.getElementById('controlPanel');
    const toggleBtn = document.getElementById('dashboardToggle');
    
    panel.classList.toggle('hidden');
    
    if (panel.classList.contains('hidden')) {
      toggleBtn.innerHTML = '<i class="fas fa-chart-line"></i>';
      toggleBtn.title = "Show Dashboard";
    } else {
      toggleBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
      toggleBtn.title = "Hide Dashboard";
    }
  }
  
  // Toggle equipment panel
  function toggleEquipmentPanel() {
    const panel = document.getElementById('equipmentPanel');
    const toggleBtn = document.getElementById('equipmentToggle');
    
    panel.classList.toggle('hidden');
    
    if (panel.classList.contains('hidden')) {
      toggleBtn.innerHTML = '<i class="fas fa-city"></i>';
      toggleBtn.title = "Show City Panel";
    } else {
      toggleBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
      toggleBtn.title = "Hide City Panel";
    }
    updateEquipmentTogglePosition();
  }
  
  // Update equipment toggle position
  function updateEquipmentTogglePosition() {
    const panel = document.getElementById('equipmentPanel');
    const toggleBtn = document.getElementById('equipmentToggle');
    if (!panel || !toggleBtn) return;

    if (panel.classList.contains('hidden')) {
      toggleBtn.style.right = '20px';
      toggleBtn.style.top = '50%';
      toggleBtn.style.transform = 'translateY(-50%)';
      return;
    }

    const rect = panel.getBoundingClientRect();
    const gap = 20;
    toggleBtn.style.right = (window.innerWidth - rect.right + gap) + 'px';
    toggleBtn.style.top = '50%';
    toggleBtn.style.transform = 'translateY(-50%)';
  }

  // Observe panel resize
  (function initEquipmentResizeObserver() {
    const panel = document.getElementById('equipmentPanel');
    if (!panel || typeof ResizeObserver === 'undefined') return;
    const ro = new ResizeObserver(() => {
      updateEquipmentTogglePosition();
    });
    ro.observe(panel);
    window.addEventListener('resize', updateEquipmentTogglePosition);
  })();
  
  // Function to update city panel
  function updateCityPanel() {
    if (currentTab === 'site') {
      updateSiteCityPanel();
    } else {
      updateAssetCityPanel();
    }
  }
  
  // Update city panel for Site Information
  function updateSiteCityPanel() {
    const selectedCity = document.getElementById('siteCityFilter').value;
    const cityNameElement = document.getElementById('citySiteName');
    const currentCityNameElement = document.getElementById('currentCityName');
    
    if (selectedCity === 'all') {
      document.getElementById('panelTitle').textContent = 'City Overview';
      document.getElementById('panelIcon').className = 'fas fa-city';
      cityNameElement.textContent = 'All Cities';
      currentCityNameElement.textContent = 'All Cities';
    } else {
      const cityName = document.getElementById('siteCityFilter').options[document.getElementById('siteCityFilter').selectedIndex].text;
      const cityNameParts = cityName.split(' (');
      const cleanCityName = cityNameParts[0];
      document.getElementById('panelTitle').textContent = `${cleanCityName} Overview`;
      document.getElementById('panelIcon').className = 'fas fa-map-marker-alt';
      cityNameElement.textContent = cleanCityName;
      currentCityNameElement.textContent = cleanCityName;
    }
    
    let citySites = selectedCity === 'all' ? allSites : allSites.filter(s => s.city === selectedCity);
    
    if (currentSiteChartType === 'siteType') {
      updateSiteTypeDistributionForSites(citySites);
    } else {
      updateSiteStatusDistribution(citySites);
    }
  }
  
  // Update city panel for Asset Information
  function updateAssetCityPanel() {
    const selectedCity = document.getElementById('cityFilter').value;
    const cityNameElement = document.getElementById('citySiteName');
    const currentCityNameElement = document.getElementById('currentCityName');
    
    if (selectedCity === 'all') {
      document.getElementById('panelTitle').textContent = 'City Overview';
      document.getElementById('panelIcon').className = 'fas fa-city';
      cityNameElement.textContent = 'All Cities';
      currentCityNameElement.textContent = 'All Cities';
    } else {
      const cityName = document.getElementById('cityFilter').options[document.getElementById('cityFilter').selectedIndex].text;
      const cityNameParts = cityName.split(' (');
      const cleanCityName = cityNameParts[0];
      document.getElementById('panelTitle').textContent = `${cleanCityName} Overview`;
      document.getElementById('panelIcon').className = 'fas fa-map-marker-alt';
      cityNameElement.textContent = cleanCityName;
      currentCityNameElement.textContent = cleanCityName;
    }
    
    let cityAssets = selectedCity === 'all' ? allAssets : allAssets.filter(a => a.city === selectedCity);
    
    if (currentChartType === 'siteType') {
      updateSiteTypeDistribution(cityAssets);
    } else {
      updateConditionDistribution(cityAssets);
    }
  }
  
  // Update site type distribution for Assets
  function updateSiteTypeDistribution(assets) {
    let siteTypeStats = {};
    let totalSites = 0;
    let uniqueSites = new Set();
    
    assets.forEach(asset => {
      if (asset.siteTypeL2) {
        const siteTypeKey = asset.siteTypeL2;
        if (!siteTypeStats[siteTypeKey]) {
          siteTypeStats[siteTypeKey] = {
            count: 0,
            uniqueSites: new Set(),
            abbreviation: getSiteTypeAbbreviation(asset.siteTypeL2)
          };
        }
        siteTypeStats[siteTypeKey].count++;
        siteTypeStats[siteTypeKey].uniqueSites.add(asset.siteNameL3);
        uniqueSites.add(asset.siteNameL3);
        totalSites++;
      }
    });
    
    const uniqueSiteTypes = Object.keys(siteTypeStats).length;
    
    document.getElementById('distributionTypeLabel').textContent = 'Site Types';
    document.getElementById('distributionTypesCount').textContent = uniqueSiteTypes;
    document.getElementById('distributionTypeSubLabel').textContent = 'Total Site Types';
    document.getElementById('chartTitle').textContent = 'Site Type Distribution';
    document.getElementById('chartIcon').className = 'fas fa-chart-pie';
    document.getElementById('distributionTitle').textContent = 'Site Types';
    document.getElementById('distributionIcon').className = 'fas fa-layer-group';
    
    updateDistributionList(siteTypeStats, 'siteType');
    updateDistributionChart(siteTypeStats, 'siteType');
    
    // FIX: Use assets.length instead of uniqueSites.size to match left panel counting
    document.getElementById('totalSitesCount').textContent = assets.length;
  }
  
  // Update site type distribution for Sites
  function updateSiteTypeDistributionForSites(sites) {
    let siteTypeStats = {};
    let totalSites = 0;
    let uniqueSites = new Set();
    
    sites.forEach(site => {
      if (site.siteType) {
        const siteTypeKey = site.siteType;
        if (!siteTypeStats[siteTypeKey]) {
          siteTypeStats[siteTypeKey] = {
            count: 0,
            uniqueSites: new Set(),
            abbreviation: getSiteTypeAbbreviation(site.siteType)
          };
        }
        siteTypeStats[siteTypeKey].count++;
        siteTypeStats[siteTypeKey].uniqueSites.add(site.siteName || site.siteId);
        uniqueSites.add(site.siteName || site.siteId);
        totalSites++;
      }
    });
    
    const uniqueSiteTypes = Object.keys(siteTypeStats).length;
    
    document.getElementById('distributionTypeLabel').textContent = 'Site Types';
    document.getElementById('distributionTypesCount').textContent = uniqueSiteTypes;
    document.getElementById('distributionTypeSubLabel').textContent = 'Total Site Types';
    document.getElementById('chartTitle').textContent = 'Site Type Distribution';
    document.getElementById('chartIcon').className = 'fas fa-chart-pie';
    document.getElementById('distributionTitle').textContent = 'Site Types';
    document.getElementById('distributionIcon').className = 'fas fa-layer-group';
    
    updateDistributionList(siteTypeStats, 'siteType');
    updateDistributionChart(siteTypeStats, 'siteType');
    
    // FIX: Use sites.length instead of uniqueSites.size to match left panel counting
    document.getElementById('totalSitesCount').textContent = sites.length;
  }
  
  // Update condition distribution for Assets
  function updateConditionDistribution(assets) {
    let conditionStats = {};
    let totalSites = 0;
    let uniqueSites = new Set();
    
    assets.forEach(asset => {
      const conditionKey = asset.condition || 'UNKNOWN';
      if (!conditionStats[conditionKey]) {
        conditionStats[conditionKey] = {
          count: 0,
          uniqueSites: new Set(),
          abbreviation: conditionKey
        };
      }
      conditionStats[conditionKey].count++;
      conditionStats[conditionKey].uniqueSites.add(asset.siteNameL3);
      uniqueSites.add(asset.siteNameL3);
      totalSites++;
    });
    
    const uniqueConditions = Object.keys(conditionStats).length;
    
    document.getElementById('distributionTypeLabel').textContent = 'Conditions';
    document.getElementById('distributionTypesCount').textContent = uniqueConditions;
    document.getElementById('distributionTypeSubLabel').textContent = 'Different Conditions';
    document.getElementById('chartTitle').textContent = 'Condition Distribution';
    document.getElementById('chartIcon').className = 'fas fa-tachometer-alt';
    document.getElementById('distributionTitle').textContent = 'Conditions';
    document.getElementById('distributionIcon').className = 'fas fa-heartbeat';
    
    updateDistributionList(conditionStats, 'condition');
    updateDistributionChart(conditionStats, 'condition');
    
    // FIX: Use assets.length instead of uniqueSites.size to match left panel counting
    document.getElementById('totalSitesCount').textContent = assets.length;
  }
  
  // Update site status distribution for Sites
  function updateSiteStatusDistribution(sites) {
    let statusStats = {};
    let totalSites = 0;
    let uniqueSites = new Set();
    
    sites.forEach(site => {
      const statusKey = site.siteStatus || 'UNKNOWN';
      if (!statusStats[statusKey]) {
        statusStats[statusKey] = {
          count: 0,
          uniqueSites: new Set(),
          abbreviation: statusKey
        };
      }
      statusStats[statusKey].count++;
      statusStats[statusKey].uniqueSites.add(site.siteName || site.siteId);
      uniqueSites.add(site.siteName || site.siteId);
      totalSites++;
    });
    
    const uniqueStatuses = Object.keys(statusStats).length;
    
    document.getElementById('distributionTypeLabel').textContent = 'Site Statuses';
    document.getElementById('distributionTypesCount').textContent = uniqueStatuses;
    document.getElementById('distributionTypeSubLabel').textContent = 'Different Statuses';
    document.getElementById('chartTitle').textContent = 'Site Status Distribution';
    document.getElementById('chartIcon').className = 'fas fa-tachometer-alt';
    document.getElementById('distributionTitle').textContent = 'Site Statuses';
    document.getElementById('distributionIcon').className = 'fas fa-heartbeat';
    
    updateDistributionList(statusStats, 'siteStatus');
    updateDistributionChart(statusStats, 'siteStatus');
    
    // FIX: Use sites.length instead of uniqueSites.size to match left panel counting
    document.getElementById('totalSitesCount').textContent = sites.length;
  }
  
  // Get color for site type - UPDATED: WABS changed to teal/cyan (#00D4AA)
  function getColorForSiteType(siteType) {
    if (siteTypeColorMap[siteType]) {
      return siteTypeColorMap[siteType];
    }
    
    // Assign colors based on site type abbreviation
    const abbrev = getSiteTypeAbbreviation(siteType);
    let color;
    
    switch(abbrev) {
      case 'WTNK': color = '#36A2EB'; break;
      case 'WWPS': color = '#FF6384'; break; // Pink/red - kept same
      case 'WWTP': color = '#FFCE56'; break;
      case 'WFLS': color = '#4BC0C0'; break;
      case 'WPUS': color = '#9966FF'; break;
      case 'WTRP': color = '#FF9F40'; break;
      case 'WABS': color = '#00D4AA'; break; // Changed to teal/cyan
      default:
        const colorIndex = Object.keys(siteTypeColorMap).length % siteTypeColors.length;
        color = siteTypeColors[colorIndex];
    }
    
    siteTypeColorMap[siteType] = color;
    return color;
  }
  
  // Get color for condition
  function getColorForCondition(condition) {
    if (conditionColorMap[condition]) {
      return conditionColorMap[condition];
    }
    
    // Assign colors based on condition
    let color = conditionColors[condition] || '#6D6A75';
    conditionColorMap[condition] = color;
    return color;
  }
  
  // Get color for site status
  function getColorForSiteStatus(status) {
    if (siteStatusColorMap[status]) {
      return siteStatusColorMap[status];
    }
    
    // Assign colors based on site status
    let color = siteStatusColors[status] || '#6D6A75';
    siteStatusColorMap[status] = color;
    return color;
  }
  
  // Update distribution list - UPDATED: Remove grey descriptive text
  function updateDistributionList(stats, type) {
    const gridContainer = document.getElementById('distributionGrid');
    gridContainer.innerHTML = '';
    
    const sortedItems = Object.keys(stats).sort((a, b) => stats[b].count - stats[a].count);
    
    sortedItems.forEach(item => {
      const count = stats[item].count;
      const uniqueSites = stats[item].uniqueSites.size;
      const abbreviation = stats[item].abbreviation || item;
      let color;
      let iconClass;
      
      if (type === 'siteType') {
        color = getColorForSiteType(item);
        iconClass = 'fas fa-building';
      } else if (type === 'condition') {
        color = getColorForCondition(item);
        iconClass = 'fas fa-tachometer-alt';
      } else if (type === 'siteStatus') {
        color = getColorForSiteStatus(item);
        iconClass = 'fas fa-flag';
      }
      
      const itemDiv = document.createElement('div');
      itemDiv.className = `distribution-item ${type === 'siteType' ? getSiteTypeAbbreviation(item) : item.replace(' ', '_')}`;
      itemDiv.innerHTML = `
        <div class="distribution-icon">
          <i class="${iconClass}"></i>
        </div>
        <div class="distribution-info">
          <div class="distribution-name">${abbreviation}</div>
          <div class="distribution-count">${count}</div>
        </div>
      `;
      gridContainer.appendChild(itemDiv);
    });
  }
  
  // Update distribution chart
  function updateDistributionChart(stats, type) {
    const ctx = document.getElementById('equipmentChart');
    
    if (equipmentChart) {
      equipmentChart.destroy();
    }
    
    const items = Object.keys(stats);
    const labels = [];
    const data = [];
    const colors = [];
    const hoverColors = [];
    const borderColors = [];
    
    const sortedItems = items.sort((a, b) => stats[b].count - stats[a].count).slice(0, 8);
    
    sortedItems.forEach(item => {
      const count = stats[item].count;
      const abbreviation = stats[item].abbreviation || item;
      labels.push(abbreviation);
      data.push(count);
      let color;
      if (type === 'siteType') {
        color = getColorForSiteType(item);
      } else if (type === 'condition') {
        color = getColorForCondition(item);
      } else if (type === 'siteStatus') {
        color = getColorForSiteStatus(item);
      }
      colors.push(color);
      hoverColors.push(lightenColor(color, 20));
      borderColors.push(isDarkTheme ? '#0d1117' : '#ffffff');
    });
    
    if (data.length === 0 || data.reduce((a, b) => a + b, 0) === 0) {
      createEmptyChart(ctx);
      return;
    }
    
    equipmentChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: colors,
          borderColor: borderColors,
          borderWidth: 2,
          hoverBackgroundColor: hoverColors,
          hoverBorderColor: isDarkTheme ? '#0d1117' : '#ffffff',
          hoverBorderWidth: 3,
          borderRadius: 6,
          spacing: 1
        }]
      },
      options: {
        responsive: false,
        maintainAspectRatio: false,
        cutout: '65%',
        rotation: -90,
        circumference: 360,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: isDarkTheme ? '#161b22' : 'rgba(0, 0, 0, 0.8)',
            titleColor: isDarkTheme ? '#e6edf3' : '#ffffff',
            bodyColor: isDarkTheme ? '#e6edf3' : '#ffffff',
            borderColor: isDarkTheme ? '#30363d' : 'rgba(255, 255, 255, 0.2)',
            borderWidth: 1,
            cornerRadius: 6,
            padding: 10,
            displayColors: true,
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = Math.round((value / total) * 100);
                return `${label}: ${value} ${type === 'siteType' ? 'sites' : type === 'condition' ? 'assets' : 'sites'} (${percentage}%)`;
              }
            }
          },
          datalabels: {
            display: true,
            color: isDarkTheme ? '#e6edf3' : '#ffffff',
            font: {
              size: 12,
              weight: 'bold'
            },
            formatter: (value, ctx) => {
              const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = Math.round((value / total) * 100);
              return percentage > 10 ? `${percentage}%` : '';
            }
          }
        },
        animation: {
          animateScale: true,
          animateRotate: true,
          duration: 800,
          easing: 'easeOutQuart'
        },
        hover: {
          mode: 'nearest',
          intersect: true,
          animationDuration: 200
        },
        elements: {
          arc: {
            borderWidth: 2,
            borderColor: isDarkTheme ? '#0d1117' : '#ffffff',
            hoverBorderWidth: 3,
            hoverBorderColor: isDarkTheme ? '#0d1117' : '#ffffff'
          }
        }
      }
    });
  }
  
  // Helper function to lighten colors
  function lightenColor(color, percent) {
    const num = parseInt(color.replace("#", ""), 16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) + amt;
    const G = (num >> 8 & 0x00FF) + amt;
    const B = (num & 0x0000FF) + amt;
    
    const finalR = R > 255 ? 255 : R < 0 ? 0 : R;
    const finalG = G > 255 ? 255 : G < 0 ? 0 : G;
    const finalB = B > 255 ? 255 : B < 0 ? 0 : B;
    
    return "#" + 
      (finalR.toString(16).padStart(2, '0')) +
      (finalG.toString(16).padStart(2, '0')) +
      (finalB.toString(16).padStart(2, '0'));
  }
  
  // Create empty chart
  function createEmptyChart(ctx) {
    if (equipmentChart) {
      equipmentChart.destroy();
    }
    
    equipmentChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['No Data'],
        datasets: [{
          data: [1],
          backgroundColor: [isDarkTheme ? '#30363d' : '#ecf0f1'],
          borderColor: isDarkTheme ? '#0d1117' : 'white',
          borderWidth: 2
        }]
      },
      options: {
        responsive: false,
        maintainAspectRatio: false,
        cutout: '65%',
        rotation: -90,
        circumference: 360,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            enabled: false
          },
          datalabels: {
            display: false
          }
        },
        animation: {
          animateScale: false,
          animateRotate: false
        }
      }
    });
    
    const centerTextPlugin = {
      id: 'centerText',
      afterDraw(chart) {
        const { ctx, chartArea: { left, right, top, bottom, width, height } } = chart;
        
        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        ctx.fillStyle = isDarkTheme ? '#8b949e' : '#7f8c8d';
        ctx.font = 'bold 16px "Segoe UI", "Inter", sans-serif';
        ctx.fillText('No Data', width / 2, height / 2 - 8);
        
        ctx.fillStyle = isDarkTheme ? '#6e7681' : '#bdc3c7';
        ctx.font = '12px "Segoe UI", "Inter", sans-serif';
        ctx.fillText('Select a different city or filter', width / 2, height / 2 + 12);
        
        ctx.restore();
      }
    };
    
    Chart.register(centerTextPlugin);
  }
  
  // Get asset icon - UPDATED: SMALLER FONT SIZE TO FIT IN CIRCLE
  function getAssetIcon(asset) {
    const siteType = asset.siteTypeL2 || 'Other';
    const abbreviation = getSiteTypeAbbreviation(siteType);
    const siteTypeClass = getSiteTypeClass(siteType);
    const color = getColorForSiteType(siteType);
    
    // Determine marker size based on zoom level
    let size = 28;
    let fontSize = 9;
    
    if (currentZoom >= 15) {
      size = 32;
      fontSize = 10;
    } else if (currentZoom <= 10) {
      size = 24;
      fontSize = 8;
    }
    
    return L.divIcon({
      html: `
        <div class="site-type-marker ${siteTypeClass}" style="
          width: ${size}px;
          height: ${size}px;
          font-size: ${fontSize}px;
          background: ${color};
          display: flex;
          align-items: center;
          justify-content: center;
        ">
          ${abbreviation}
          ${asset.working === 'NO' ? '<div style="position: absolute; top: -2px; right: -2px; width: 6px; height: 6px; background: #e74c3c; border: 1px solid white; border-radius: 50%;"></div>' : ''}
          ${asset.inUse === 'YES' ? '<div style="position: absolute; bottom: -2px; right: -2px; width: 6px; height: 6px; background: #00b4d8; border: 1px solid white; border-radius: 50%;"></div>' : ''}
        </div>
      `,
      className: 'site-type-marker-icon',
      iconSize: [size, size],
      iconAnchor: [size/2, size/2]
    });
  }
  
  // Get site icon
  function getSiteIcon(site) {
    const siteType = site.siteType || 'Other';
    const abbreviation = getSiteTypeAbbreviation(siteType);
    const siteTypeClass = getSiteTypeClass(siteType);
    const color = getColorForSiteType(siteType);
    
    // Determine marker size based on zoom level
    let size = 28;
    let fontSize = 9;
    
    if (currentZoom >= 15) {
      size = 32;
      fontSize = 10;
    } else if (currentZoom <= 10) {
      size = 24;
      fontSize = 8;
    }
    
    // Get status indicator color
    let statusColor = '#6D6A75'; // Default unknown
    if (site.siteStatus === 'WORKING') statusColor = '#00b894';
    else if (site.siteStatus === 'STANDBY') statusColor = '#FFD166';
    else if (site.siteStatus === 'OUT_OF_SERVICE') statusColor = '#FF9E6D';
    else if (site.siteStatus === 'CWIP') statusColor = '#9D4EDD';
    else if (site.siteStatus === 'TRANSFER') statusColor = '#00A8FF';
    
    return L.divIcon({
      html: `
        <div class="site-type-marker ${siteTypeClass}" style="
          width: ${size}px;
          height: ${size}px;
          font-size: ${fontSize}px;
          background: ${color};
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
        ">
          ${abbreviation}
          <div style="position: absolute; top: -2px; right: -2px; width: 6px; height: 6px; background: ${statusColor}; border: 1px solid white; border-radius: 50%;"></div>
        </div>
      `,
      className: 'site-type-marker-icon',
      iconSize: [size, size],
      iconAnchor: [size/2, size/2]
    });
  }
  
  // Build popup content for asset
  function buildAssetPopup(asset) {
    const conditionColor = getConditionColor(asset.condition);
    const siteTypeAbbrev = getSiteTypeAbbreviation(asset.siteTypeL2);
    const siteTypeColor = getColorForSiteType(asset.siteTypeL2);
    
    return `
      <div class="popup-header">
        <h3>${asset.siteNameL3}</h3>
        <div style="font-size: 0.85em; opacity: 0.9;">
          <i class="fas fa-city"></i> ${asset.city} | 
          <span style="background:${siteTypeColor};color:white;padding:2px 6px;border-radius:4px;font-weight:bold;">
            ${siteTypeAbbrev}
          </span>
        </div>
      </div>
      <div class="popup-content">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 6px; background: rgba(0,0,0,0.03); border-radius: 8px;">
          <div style="width: 40px; height: 40px; border-radius: 50%; background: ${siteTypeColor}; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; box-shadow: 0 3px 6px rgba(0,0,0,0.2);">
            ${siteTypeAbbrev}
          </div>
          <div>
            <h4 style="margin: 0; color: #343a40; font-size: 1em;">${asset.assetId}</h4>
            <p style="margin: 4px 0 0; color: #6c757d; font-size: 0.8em;">${asset.siteTypeL2}</p>
          </div>
        </div>
        
        <div style="margin: 10px 0; font-size: 0.9em;">
          <p><i class="fas fa-map-marker-alt"></i> <strong>Coordinates:</strong> ${asset.latitude.toFixed(6)}, ${asset.longitude.toFixed(6)}</p>
          <p><i class="fas fa-building"></i> <strong>Building:</strong> ${asset.building}</p>
          ${asset.equipmentType && asset.equipmentType !== 'Unknown' ? `<p><i class="fas fa-cogs"></i> <strong>Equipment Type:</strong> ${asset.equipmentType}</p>` : ''}
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 15px 0;">
          <div style="padding: 8px; background: ${asset.working === 'YES' ? '#00b894' : '#e74c3c'}; color: white; border-radius: 6px; text-align: center; box-shadow: 0 3px 6px rgba(0,0,0,0.1); font-size: 0.9em;">
            <strong><i class="fas fa-power-off"></i> Status</strong><br>
            ${asset.working === 'YES' ? '<i class="fas fa-check"></i> Working' : '<i class="fas fa-times"></i> Not Working'}
          </div>
          <div style="padding: 8px; background: ${conditionColor}; color: white; border-radius: 6px; text-align: center; box-shadow: 0 3px 6px rgba(0,0,0,0.1); font-size: 0.9em;">
            <strong><i class="fas fa-tachometer-alt"></i> Condition</strong><br>
            ${asset.condition}
          </div>
        </div>
      </div>
    `;
  }
  
  // Build popup content for site
  function buildSitePopup(site) {
    const siteTypeAbbrev = getSiteTypeAbbreviation(site.siteType);
    const siteTypeColor = getColorForSiteType(site.siteType);
    const statusColor = getColorForSiteStatus(site.siteStatus);
    
    return `
      <div class="popup-header">
        <h3>${site.siteName || site.siteId}</h3>
        <div style="font-size: 0.85em; opacity: 0.9;">
          <i class="fas fa-city"></i> ${site.city} | 
          <span style="background:${siteTypeColor};color:white;padding:2px 6px;border-radius:4px;font-weight:bold;">
            ${siteTypeAbbrev}
          </span>
        </div>
      </div>
      <div class="popup-content">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 6px; background: rgba(0,0,0,0.03); border-radius: 8px;">
          <div style="width: 40px; height: 40px; border-radius: 50%; background: ${siteTypeColor}; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; box-shadow: 0 3px 6px rgba(0,0,0,0.2);">
            ${siteTypeAbbrev}
          </div>
          <div>
            <h4 style="margin: 0; color: #343a40; font-size: 1em;">${site.siteId || 'Site'}</h4>
            <p style="margin: 4px 0 0; color: #6c757d; font-size: 0.8em;">${site.siteType}</p>
          </div>
        </div>
        
        <div style="margin: 10px 0; font-size: 0.9em;">
          <p><i class="fas fa-map-marker-alt"></i> <strong>Coordinates:</strong> ${site.latitude.toFixed(6)}, ${site.longitude.toFixed(6)}</p>
          ${site.description ? `<p><i class="fas fa-info-circle"></i> <strong>Description:</strong> ${site.description}</p>` : ''}
          ${site.capacity ? `<p><i class="fas fa-chart-bar"></i> <strong>Capacity:</strong> ${site.capacity}</p>` : ''}
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr; gap: 8px; margin: 15px 0;">
          <div style="padding: 8px; background: ${statusColor}; color: white; border-radius: 6px; text-align: center; box-shadow: 0 3px 6px rgba(0,0,0,0.1); font-size: 0.9em;">
            <strong><i class="fas fa-flag"></i> Site Status</strong><br>
            ${site.siteStatus}
          </div>
        </div>
      </div>
    `;
  }
  
  // Get condition color
  function getConditionColor(condition) {
    return conditionColors[condition] || '#636e72';
  }
  
  // Load CSV data
  function loadCSVData() {
    // Load Site Type Data CSV
    Papa.parse('site_type_data.csv', {
      download: true,
      header: true,
      dynamicTyping: false,
      skipEmptyLines: true,
      complete: function(results) {
        if (results.errors.length > 0) {
          console.error('Site CSV parsing errors:', results.errors);
          showNotification('Error loading Site CSV data. Please check console for details.', 'error');
          createSampleSiteData();
          return;
        }
        
        console.log('Site CSV column names:', results.meta.fields);
        
        // Parse site data
        allSites = parseSiteData(results.data, results.meta.fields);
        filteredSites = [...allSites];
        
        // Calculate site statistics
        calculateSiteInformationStats();
        updateSiteDashboard();
        updateSiteCityFilter();
        updateSiteTypeFilter();
        updateSiteStatusFilter();
        
        // Initialize city tour
        initCityTour();
        
        // Load Asset Data CSV
        loadAssetCSVData();
      },
      error: function(error) {
        console.error('Error loading Site CSV:', error);
        showNotification('Error loading Site CSV file. Creating sample site data.', 'info');
        createSampleSiteData();
        loadAssetCSVData();
      }
    });
  }
  
  // Parse site data from CSV - UPDATED: Only use Site Information CSV
  function parseSiteData(data, fields) {
    let siteNameColumn = null;
    let cityColumn = null;
    let siteTypeColumn = null;
    let siteStatusColumn = null;
    let latitudeColumn = null;
    let longitudeColumn = null;
    
    // Find columns - ONLY from Site Information CSV
    for (let col of fields) {
      const colLower = col.toLowerCase();
      
      if (colLower.includes('site') && (colLower.includes('name') || colLower.includes('id'))) {
        siteNameColumn = col;
      }
      
      if (colLower === 'city') {
        cityColumn = col;
      }
      
      if (colLower.includes('site') && colLower.includes('type')) {
        siteTypeColumn = col;
      }
      
      if (colLower.includes('status')) {
        siteStatusColumn = col;
      }
      
      if (colLower === 'latitude' || colLower === 'lat') {
        latitudeColumn = col;
      }
      
      if (colLower === 'longitude' || colLower === 'lon' || colLower === 'lng') {
        longitudeColumn = col;
      }
    }
    
    const sites = data.map((row, index) => {
      let siteName = 'Unknown Site';
      if (siteNameColumn && row[siteNameColumn]) {
        siteName = row[siteNameColumn].toString().trim();
        if (!siteName) siteName = 'Unknown Site';
      }
      
      let city = 'Unknown City';
      if (cityColumn && row[cityColumn]) {
        city = row[cityColumn].toString().trim();
        if (!city) city = 'Unknown City';
      }
      
      let siteType = 'Other';
      if (siteTypeColumn && row[siteTypeColumn]) {
        siteType = row[siteTypeColumn].toString().trim();
        if (!siteType) siteType = 'Other';
      }
      
      let siteStatus = 'UNKNOWN';
      if (siteStatusColumn && row[siteStatusColumn]) {
        siteStatus = row[siteStatusColumn].toString().trim().toUpperCase().replace(/ /g, '_');
        
        // Normalize status values
        if (siteStatus.includes('WORKING')) siteStatus = 'WORKING';
        else if (siteStatus.includes('STANDBY')) siteStatus = 'STANDBY';
        else if (siteStatus.includes('OUT') && siteStatus.includes('SERVICE')) siteStatus = 'OUT_OF_SERVICE';
        else if (siteStatus.includes('CWIP')) siteStatus = 'CWIP';
        else if (siteStatus.includes('TRANSFER')) siteStatus = 'TRANSFER';
      }
      
      let latitude = 0;
      let longitude = 0;
      
      if (latitudeColumn && row[latitudeColumn]) {
        latitude = parseFloat(row[latitudeColumn]);
        if (isNaN(latitude)) latitude = 0;
      }
      
      if (longitudeColumn && row[longitudeColumn]) {
        longitude = parseFloat(row[longitudeColumn]);
        if (isNaN(longitude)) longitude = 0;
      }
      
      return {
        id: index,
        siteId: row['Site_ID'] || row['Site ID'] || row['site_id'] || `SITE-${index}`,
        siteName: siteName,
        city: city,
        siteType: siteType,
        siteStatus: siteStatus,
        description: row['Description'] || row['description'] || '',
        capacity: row['Capacity'] || row['capacity'] || '',
        latitude: latitude,
        longitude: longitude
      };
    }).filter(site => {
      // Filter out invalid coordinates with enhanced validation
      const hasValidCoords = !isNaN(site.latitude) && 
             !isNaN(site.longitude) &&
             site.latitude !== 0 && 
             site.longitude !== 0 &&
             Math.abs(site.latitude) <= 90 &&
             Math.abs(site.longitude) <= 180;
      
      // Log invalid entries for debugging
      if (!hasValidCoords) {
        console.warn(`Filtered out site with invalid coordinates: ${site.siteName} (${site.latitude}, ${site.longitude})`);
      }
      
      return hasValidCoords;
    });
    
    console.log(`Loaded ${sites.length} valid sites from Site Information CSV`);
    return sites;
  }
  
  // Load Asset CSV data
  function loadAssetCSVData() {
    Papa.parse('water_assets.csv', {
      download: true,
      header: true,
      dynamicTyping: false,
      skipEmptyLines: true,
      complete: function(results) {
        if (results.errors.length > 0) {
          console.error('Asset CSV parsing errors:', results.errors);
          showNotification('Error loading Asset CSV data. Please check console for details.', 'error');
          createSampleAssetData();
          return;
        }
        
        console.log('Asset CSV column names:', results.meta.fields);
        
        // Parse asset data
        allAssets = parseAssetData(results.data, results.meta.fields);
        filteredAssets = [...allAssets];
        
        // Calculate asset statistics
        calculateAssetStats();
        updateDashboard();
        updateConditionFilter();
        updateSiteFilter();
        updateCityFilter();
        
        // Display initial markers (sites by default)
        displaySiteMarkers();
        
        // Update panels
        updateCityPanel();
        updateSiteHealthIndicator();
        updateSiteNameDisplay();
        
        // Initialize city tour for asset data
        if (currentTab === 'asset') {
          initCityTour();
        }
        
        showNotification(`Successfully loaded ${allSites.length} sites and ${allAssets.length} assets`, 'success');
        
        // Show equipment panel after a delay
        setTimeout(() => {
          toggleEquipmentPanel();
        }, 1000);
      },
      error: function(error) {
        console.error('Error loading Asset CSV:', error);
        showNotification('Error loading Asset CSV file. Creating sample asset data.', 'info');
        createSampleAssetData();
      }
    });
  }
  
  // Parse asset data from CSV
  function parseAssetData(data, fields) {
    let siteNameColumn = null;
    let cityColumn = null;
    let siteTypeL2Column = null;
    let conditionColumn = null;
    let equipmentTypeColumn = null;
    let latitudeColumn = null;
    let longitudeColumn = null;
    
    // Find columns
    for (let col of fields) {
      const colLower = col.toLowerCase();
      
      if (colLower === 'city') {
        cityColumn = col;
      }
      
      if (colLower === 'latitude') {
        latitudeColumn = col;
      }
      
      if (colLower === 'longitude') {
        longitudeColumn = col;
      }
      
      if (colLower.includes('site') && colLower.includes('name') && colLower.includes('l3')) {
        siteNameColumn = col;
      }
      
      if (colLower.includes('site') && colLower.includes('type') && colLower.includes('l2')) {
        siteTypeL2Column = col;
      }
      
      if (colLower.includes('condition')) {
        conditionColumn = col;
      }
      
      if (colLower.includes('equipment') && colLower.includes('type') && colLower.includes('l6')) {
        equipmentTypeColumn = col;
      }
    }
    
    const assets = data.map((row, index) => {
      let siteName = 'Unknown Site';
      if (siteNameColumn && row[siteNameColumn]) {
        siteName = row[siteNameColumn].toString().trim();
        if (!siteName) siteName = 'Unknown Site';
      }
      
      let city = 'Unknown City';
      if (cityColumn && row[cityColumn]) {
        city = row[cityColumn].toString().trim();
        if (!city) city = 'Unknown City';
      }
      
      let siteTypeL2 = 'Other';
      if (siteTypeL2Column && row[siteTypeL2Column]) {
        siteTypeL2 = row[siteTypeL2Column].toString().trim();
        if (!siteTypeL2) siteTypeL2 = 'Other';
      }
      
      let condition = 'UNKNOWN';
      if (conditionColumn && row[conditionColumn]) {
        condition = row[conditionColumn].toString().trim().toUpperCase();
        
        if (condition.includes('EXCELLENT') || condition === 'EXCELENT') condition = 'EXCELLENT';
        else if (condition.includes('VERY GOOD') || condition === 'VERYGOOD') condition = 'VERY GOOD';
        else if (condition.includes('GOOD')) condition = 'GOOD';
        else if (condition.includes('NEW')) condition = 'NEW';
        else if (condition.includes('FAIR')) condition = 'FAIR';
        else if (condition.includes('POOR')) condition = 'POOR';
        else if (condition.includes('CRITICAL')) condition = 'CRITICAL';
      }
      
      let equipmentType = 'Unknown';
      if (equipmentTypeColumn && row[equipmentTypeColumn]) {
        equipmentType = row[equipmentTypeColumn].toString().trim();
        if (!equipmentType) equipmentType = 'Unknown';
      }
      
      const inUse = (row['In_Use'] || row['In Use'] || row['in_use'] || row['IN_USE'] || 'NO').toString().toUpperCase().trim();
      const working = (row['Working'] || row['working'] || row['WORKING'] || 'NO').toString().toUpperCase().trim();
      
      let latitude = 0;
      let longitude = 0;
      
      if (latitudeColumn && row[latitudeColumn]) {
        latitude = parseFloat(row[latitudeColumn]);
        if (isNaN(latitude)) latitude = 0;
      }
      
      if (longitudeColumn && row[longitudeColumn]) {
        longitude = parseFloat(row[longitudeColumn]);
        if (isNaN(longitude)) longitude = 0;
      }
      
      if (latitude === 0 && row['Latitude']) latitude = parseFloat(row['Latitude']);
      if (longitude === 0 && row['Longitude']) longitude = parseFloat(row['Longitude']);
      
      return {
        id: index,
        assetId: row['Asset_ID'] || row['Asset ID'] || row['asset_id'] || row['ASSET_ID'] || `ASSET-${index}`,
        facilityId: row['Facility_ID'] || row['Facility ID'] || row['facility_id'] || 'N/A',
        siteNameL3: siteName,
        city: city,
        siteTypeL2: siteTypeL2,
        building: row['Building'] || row['building'] || 'N/A',
        description: 'Water Asset',
        tagNumber: row['Tag_Number'] || row['Tag Number'] || row['tag_number'] || 'N/A',
        inUse: inUse === 'YES' ? 'YES' : 'NO',
        working: working === 'YES' ? 'YES' : 'NO',
        condition: condition,
        age: parseInt(row['AGE'] || row['age'] || 0) || 0,
        remainingLife: row['Remaining_Life'] || row['Remaining Life'] || 'N/A',
        maxLife: row['Max_Life_Time'] || row['Max Life Time'] || 'N/A',
        latitude: latitude,
        longitude: longitude,
        type: 'Pump',
        equipmentType: equipmentType,
        lastMaintenance: row['Last_Maintenance'] || row['Last Maintenance'] || 'N/A',
        nextMaintenance: row['Next_Maintenance'] || row['Next Maintenance'] || 'N/A'
      };
    }).filter(asset => {
      // Filter out invalid coordinates with enhanced validation
      const hasValidCoords = !isNaN(asset.latitude) && 
             !isNaN(asset.longitude) &&
             asset.latitude !== 0 && 
             asset.longitude !== 0 &&
             Math.abs(asset.latitude) <= 90 &&
             Math.abs(asset.longitude) <= 180;
      
      // Log invalid entries for debugging
      if (!hasValidCoords) {
        console.warn(`Filtered out asset with invalid coordinates: ${asset.assetId} (${asset.latitude}, ${asset.longitude})`);
      }
      
      return hasValidCoords;
    });
    
    console.log(`Loaded ${assets.length} valid assets`);
    return assets;
  }
  
  // Calculate site information statistics
  function calculateSiteInformationStats() {
    siteCityStats = {};
    
    allSites.forEach(site => {
      const city = site.city;
      if (!siteCityStats[city]) {
        siteCityStats[city] = {
          total: 0,
          working: 0,
          standby: 0,
          outOfService: 0,
          cwip: 0,
          transfer: 0,
          siteTypes: new Set(),
          sites: new Set()
        };
      }
      
      siteCityStats[city].total++;
      
      switch(site.siteStatus) {
        case 'WORKING': siteCityStats[city].working++; break;
        case 'STANDBY': siteCityStats[city].standby++; break;
        case 'OUT_OF_SERVICE': siteCityStats[city].outOfService++; break;
        case 'CWIP': siteCityStats[city].cwip++; break;
        case 'TRANSFER': siteCityStats[city].transfer++; break;
      }
      
      if (site.siteType) siteCityStats[city].siteTypes.add(site.siteType);
      if (site.siteName) siteCityStats[city].sites.add(site.siteName);
    });
    
    console.log('Site city statistics calculated:', siteCityStats);
  }
  
  // Update site dashboard
  function updateSiteDashboard() {
    const total = allSites.length;
    const working = allSites.filter(s => s.siteStatus === 'WORKING').length;
    const standby = allSites.filter(s => s.siteStatus === 'STANDBY').length;
    const outOfService = allSites.filter(s => s.siteStatus === 'OUT_OF_SERVICE').length;
    const cwip = allSites.filter(s => s.siteStatus === 'CWIP').length;
    const transfer = allSites.filter(s => s.siteStatus === 'TRANSFER').length;
    
    document.getElementById('totalSites').textContent = total.toLocaleString();
    document.getElementById('workingSites').textContent = working.toLocaleString();
    document.getElementById('standbySites').textContent = standby.toLocaleString();
    document.getElementById('outOfServiceSites').textContent = outOfService.toLocaleString();
    document.getElementById('cwipSites').textContent = cwip.toLocaleString();
    document.getElementById('transferSites').textContent = transfer.toLocaleString();
    
    document.getElementById('workingSitePercent').textContent = total > 0 ? Math.round((working / total) * 100) + '%' : '0%';
    document.getElementById('standbySitePercent').textContent = total > 0 ? Math.round((standby / total) * 100) + '%' : '0%';
    document.getElementById('outOfServiceSitePercent').textContent = total > 0 ? Math.round((outOfService / total) * 100) + '%' : '0%';
    document.getElementById('cwipSitePercent').textContent = total > 0 ? Math.round((cwip / total) * 100) + '%' : '0%';
    document.getElementById('transferSitePercent').textContent = total > 0 ? Math.round((transfer / total) * 100) + '%' : '0%';
    document.getElementById('totalSitePercent').textContent = '100%';
    
    updateSiteHealthIndicator();
  }
  
  // Update site city filter dropdown
  function updateSiteCityFilter() {
    const filter = document.getElementById('siteCityFilter');
    const cities = Object.keys(siteCityStats).sort();
    
    while (filter.options.length > 1) {
      filter.remove(1);
    }
    
    cities.forEach(city => {
      const count = siteCityStats[city].total;
      const option = document.createElement('option');
      option.value = city;
      option.textContent = `${city} (${count} sites)`;
      filter.appendChild(option);
    });
    
    console.log('Site city filter updated with options:', cities.length, 'cities');
  }
  
  // Update site type filter dropdown
  function updateSiteTypeFilter() {
    const filter = document.getElementById('siteTypeFilter');
    const selectedCity = document.getElementById('siteCityFilter').value;
    
    let siteTypes = [];
    if (selectedCity !== 'all') {
      siteTypes = [...new Set(allSites.filter(s => s.city === selectedCity).map(s => s.siteType))].sort();
    } else {
      siteTypes = [...new Set(allSites.map(s => s.siteType))].sort();
    }
    
    while (filter.options.length > 1) {
      filter.remove(1);
    }
    
    siteTypes.forEach(siteType => {
      let count;
      if (selectedCity !== 'all') {
        count = allSites.filter(s => s.city === selectedCity && s.siteType === siteType).length;
      } else {
        count = allSites.filter(s => s.siteType === siteType).length;
      }
      
      const option = document.createElement('option');
      option.value = siteType;
      option.textContent = `${siteType} (${count})`;
      filter.appendChild(option);
    });
    
    console.log('Site type filter updated with options:', siteTypes.length, 'site types');
  }
  
  // Update site status filter dropdown
  function updateSiteStatusFilter() {
    const filter = document.getElementById('siteStatusFilter');
    const selectedCity = document.getElementById('siteCityFilter').value;
    const selectedSiteType = document.getElementById('siteTypeFilter').value;
    
    let statuses = [];
    if (selectedSiteType !== 'all') {
      statuses = [...new Set(allSites.filter(s => s.siteType === selectedSiteType).map(s => s.siteStatus))].sort();
    } else if (selectedCity !== 'all') {
      statuses = [...new Set(allSites.filter(s => s.city === selectedCity).map(s => s.siteStatus))].sort();
    } else {
      statuses = [...new Set(allSites.map(s => s.siteStatus))].sort();
    }
    
    while (filter.options.length > 1) {
      filter.remove(1);
    }
    
    statuses.forEach(status => {
      let count;
      if (selectedSiteType !== 'all') {
        count = allSites.filter(s => s.siteType === selectedSiteType && s.siteStatus === status).length;
      } else if (selectedCity !== 'all') {
        count = allSites.filter(s => s.city === selectedCity && s.siteStatus === status).length;
      } else {
        count = allSites.filter(s => s.siteStatus === status).length;
      }
      
      const option = document.createElement('option');
      option.value = status;
      option.textContent = `${status.replace('_', ' ')} (${count})`;
      filter.appendChild(option);
    });
    
    console.log('Site status filter updated');
  }
  
  // Create sample site data for testing
  function createSampleSiteData() {
    console.log('Creating sample site data for testing...');
    
    allSites = [];
    const cities = ['AL AIS', 'AL HENAKIYAH', 'AL MADINAH', 'AL MAHD', 'AL ULA', 'BADR', 'KHAYBAR', 'WADI AL FARA', 'YANBU'];
    const siteTypes = [
      'POTABLE WATER STORAGE TANKS (WTNK)',
      'WASTE WATER PUMPING STATION (WWPS)', 
      'WASTE WATER TREATMENT PLANT (WWTP)',
      'WATER FILLING STATION (WFLS)',
      'WATER PUMPING STATION (WPUS)',
      'WATER TREATMENT PLANT (WTRP)',
      'WELL ABSTRACTION (WABS)'
    ];
    const siteNames = ['Main Water Plant', 'North Distribution Center', 'South Treatment Plant', 'East Storage Facility',
                      'West Pumping Station', 'Central Reservoir', 'Northwest Water Tower'];
    const siteStatuses = ['WORKING', 'STANDBY', 'OUT_OF_SERVICE', 'CWIP', 'TRANSFER'];
    
    let id = 1;
    
    // Generate sample sites for each city
    cities.forEach(city => {
      // Generate 3-8 sites per city
      const sitesPerCity = 3 + Math.floor(Math.random() * 6);
      
      for (let i = 0; i < sitesPerCity; i++) {
        const siteTypeIndex = Math.floor(Math.random() * siteTypes.length);
        const siteNameIndex = Math.floor(Math.random() * siteNames.length);
        const statusIndex = Math.floor(Math.random() * siteStatuses.length);
        
        // Get city coordinates
        const cityCoords = cityCoordinates[city] || { lat: 24.50, lng: 39.65 };
        
        // Add some randomness to coordinates
        const lat = cityCoords.lat + (Math.random() - 0.5) * 0.1;
        const lng = cityCoords.lng + (Math.random() - 0.5) * 0.1;
        
        allSites.push({
          id: id++,
          siteId: `SITE-${city.substring(0, 3).toUpperCase()}-${String(i+1).padStart(3, '0')}`,
          siteName: siteNames[siteNameIndex],
          city: city,
          siteType: siteTypes[siteTypeIndex],
          siteStatus: siteStatuses[statusIndex],
          description: 'Water Facility Site',
          capacity: `${Math.floor(Math.random() * 10000)} mÂ³`,
          latitude: lat,
          longitude: lng
        });
      }
    });
    
    filteredSites = [...allSites];
    
    calculateSiteInformationStats();
    updateSiteDashboard();
    updateSiteCityFilter();
    updateSiteTypeFilter();
    updateSiteStatusFilter();
  }
  
  // Create sample asset data for testing
  function createSampleAssetData() {
    console.log('Creating sample asset data for testing...');
    
    allAssets = [];
    const cities = ['AL AIS', 'AL HENAKIYAH', 'AL MADINAH', 'AL MAHD', 'AL ULA', 'BADR', 'KHAYBAR', 'WADI AL FARA', 'YANBU'];
    const siteTypes = [
      'POTABLE WATER STORAGE TANKS (WTNK)',
      'WASTE WATER PUMPING STATION (WWPS)', 
      'WASTE WATER TREATMENT PLANT (WWTP)',
      'WATER FILLING STATION (WFLS)',
      'WATER PUMPING STATION (WPUS)',
      'WATER TREATMENT PLANT (WTRP)',
      'WELL ABSTRACTION (WABS)'
    ];
    const sites = ['Main Water Plant', 'North Distribution Center', 'South Treatment Plant', 'East Storage Facility',
                  'West Pumping Station', 'Central Reservoir', 'Northwest Water Tower'];
    
    let id = 1;
    
    // Generate sample assets for each city
    cities.forEach(city => {
      // Generate 5-15 assets per city
      const assetsPerCity = 5 + Math.floor(Math.random() * 11);
      
      for (let i = 0; i < assetsPerCity; i++) {
        const siteTypeIndex = Math.floor(Math.random() * siteTypes.length);
        const siteIndex = Math.floor(Math.random() * sites.length);
        
        // Get city coordinates
        const cityCoords = cityCoordinates[city] || { lat: 24.50, lng: 39.65 };
        
        // Add some randomness to coordinates
        const lat = cityCoords.lat + (Math.random() - 0.5) * 0.1;
        const lng = cityCoords.lng + (Math.random() - 0.5) * 0.1;
        
        allAssets.push({
          id: id++,
          assetId: `ASSET-${city.substring(0, 3).toUpperCase()}-${String(i+1).padStart(3, '0')}`,
          facilityId: `FAC-${Math.floor(Math.random() * 5) + 1}`,
          siteNameL3: sites[siteIndex],
          city: city,
          siteTypeL2: siteTypes[siteTypeIndex],
          building: `Building ${String.fromCharCode(65 + Math.floor(Math.random() * 5))}`,
          description: 'Water Asset',
          tagNumber: `TAG-${i+1}`,
          inUse: Math.random() > 0.3 ? 'YES' : 'NO',
          working: Math.random() > 0.2 ? 'YES' : 'NO',
          condition: ['EXCELLENT', 'VERY GOOD', 'GOOD', 'FAIR', 'POOR', 'CRITICAL'][Math.floor(Math.random() * 6)],
          age: Math.floor(Math.random() * 15) + 1,
          remainingLife: `${Math.floor(Math.random() * 20)} years`,
          maxLife: '20 years',
          latitude: lat,
          longitude: lng,
          type: 'Pump',
          equipmentType: 'Pump Type A',
          lastMaintenance: '2023-01-15',
          nextMaintenance: '2024-01-15'
        });
      }
    });
    
    filteredAssets = [...allAssets];
    
    calculateAssetStats();
    updateDashboard();
    updateConditionFilter();
    updateSiteFilter();
    updateCityFilter();
    
    // Display initial markers
    displaySiteMarkers();
    
    // Update panels
    updateCityPanel();
    updateSiteHealthIndicator();
    updateSiteNameDisplay();
    
    showNotification('Loaded sample water assets for demonstration', 'info');
  }
  
  // Calculate asset statistics
  function calculateAssetStats() {
    siteStats = {};
    cityStats = {};
    
    allAssets.forEach(asset => {
      const site = asset.siteNameL3;
      const city = asset.city;
      
      // Site stats
      if (!siteStats[site]) {
        siteStats[site] = {
          total: 0,
          working: 0,
          notWorking: 0,
          critical: 0,
          inUse: 0,
          conditions: {}
        };
      }
      
      siteStats[site].total++;
      if (asset.working === 'YES') siteStats[site].working++;
      if (asset.working === 'NO') siteStats[site].notWorking++;
      if (asset.condition === 'CRITICAL') siteStats[site].critical++;
      if (asset.inUse === 'YES') siteStats[site].inUse++;
      
      if (!siteStats[site].conditions[asset.condition]) {
        siteStats[site].conditions[asset.condition] = 0;
      }
      siteStats[site].conditions[asset.condition]++;
      
      // City stats
      if (!cityStats[city]) {
        cityStats[city] = {
          total: 0,
          working: 0,
          notWorking: 0,
          critical: 0,
          inUse: 0,
          siteTypes: new Set(),
          sites: new Set()
        };
      }
      
      cityStats[city].total++;
      if (asset.working === 'YES') cityStats[city].working++;
      if (asset.working === 'NO') cityStats[city].notWorking++;
      if (asset.condition === 'CRITICAL') cityStats[city].critical++;
      if (asset.inUse === 'YES') cityStats[city].inUse++;
      if (asset.siteTypeL2) cityStats[city].siteTypes.add(asset.siteTypeL2);
      if (asset.siteNameL3) cityStats[city].sites.add(asset.siteNameL3);
    });
    
    console.log('Asset statistics calculated');
  }
  
  // Show notification
  function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
      <span>${message}</span>
      <button onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
    `;
    
    if (!document.querySelector('.notification')) {
      const style = document.createElement('style');
      style.textContent = `
        .notification {
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 12px 16px;
          border-radius: var(--border-radius-md);
          display: flex;
          align-items: center;
          gap: 10px;
          z-index: 3000;
          box-shadow: 0 10px 30px rgba(0,0,0,0.15);
          animation: slideInRight 0.3s ease, fadeOut 0.3s ease 4.7s forwards;
          max-width: 350px;
          font-weight: 500;
          font-size: 0.9em;
        }
        .notification.success {
          background: #00b894;
          color: white;
          border-left: 4px solid #00d2a0;
        }
        .notification.error {
          background: #e74c3c;
          color: white;
          border-left: 4px solid #ff6b6b;
        }
        .notification.info {
          background: #3498db;
          color: white;
          border-left: 4px solid #5dade2;
        }
        .notification i:first-child {
          font-size: 18px;
        }
        .notification button {
          background: none;
          border: none;
          color: white;
          cursor: pointer;
          opacity: 0.7;
          transition: opacity 0.2s;
          padding: 4px;
          margin-left: auto;
        }
        .notification button:hover {
          opacity: 1;
        }
        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
          to { opacity: 0; }
        }
      `;
      document.head.appendChild(style);
    }
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      if (notification.parentElement) {
        notification.remove();
      }
    }, 5000);
  }
  
  // Update dashboard statistics for assets
  function updateDashboard() {
    const total = allAssets.length;
    const working = allAssets.filter(a => a.working === 'YES').length;
    const notWorking = allAssets.filter(a => a.working === 'NO').length;
    
    document.getElementById('totalAssets').textContent = total.toLocaleString();
    document.getElementById('workingAssets').textContent = working.toLocaleString();
    document.getElementById('notWorkingAssets').textContent = notWorking.toLocaleString();
    
    document.getElementById('workingPercent').textContent = total > 0 ? Math.round((working / total) * 100) + '%' : '0%';
    document.getElementById('notWorkingPercent').textContent = total > 0 ? Math.round((notWorking / total) * 100) + '%' : '0%';
    
    updateHealthIndicator();
  }
  
  // Update condition filter dropdown for assets
  function updateConditionFilter() {
    const filter = document.getElementById('conditionFilter');
    const selectedSite = document.getElementById('siteFilter').value;
    const selectedCity = document.getElementById('cityFilter').value;
    
    let conditions = [];
    if (selectedSite !== 'all') {
      conditions = [...new Set(allAssets.filter(a => a.siteNameL3 === selectedSite).map(a => a.condition))].sort();
    } else if (selectedCity !== 'all') {
      conditions = [...new Set(allAssets.filter(a => a.city === selectedCity).map(a => a.condition))].sort();
    } else {
      conditions = [...new Set(allAssets.map(a => a.condition))].sort();
    }
    
    while (filter.options.length > 1) {
      filter.remove(1);
    }
    
    conditions.forEach(condition => {
      let count;
      if (selectedSite !== 'all') {
        count = allAssets.filter(a => a.siteNameL3 === selectedSite && a.condition === condition).length;
      } else if (selectedCity !== 'all') {
        count = allAssets.filter(a => a.city === selectedCity && a.condition === condition).length;
      } else {
        count = allAssets.filter(a => a.condition === condition).length;
      }
      
      const option = document.createElement('option');
      option.value = condition;
      option.textContent = `${condition} (${count})`;
      filter.appendChild(option);
    });
    
    console.log('Condition filter updated');
  }
  
  // Update site filter dropdown for assets
  function updateSiteFilter() {
    const filter = document.getElementById('siteFilter');
    const selectedCity = document.getElementById('cityFilter').value;
    
    let sites = [];
    if (selectedCity !== 'all') {
      sites = [...new Set(allAssets.filter(a => a.city === selectedCity).map(a => a.siteNameL3))].sort();
    } else {
      sites = Object.keys(siteStats).sort();
    }
    
    while (filter.options.length > 1) {
      filter.remove(1);
    }
    
    sites.forEach(site => {
      let count;
      if (selectedCity !== 'all') {
        count = allAssets.filter(a => a.city === selectedCity && a.siteNameL3 === site).length;
      } else {
        count = siteStats[site]?.total || 0;
      }
      
      const option = document.createElement('option');
      option.value = site;
      option.textContent = `${site} (${count} assets)`;
      filter.appendChild(option);
    });
    
    console.log('Site filter updated with options:', sites.length, 'sites');
  }
  
  // Update city filter dropdown for assets
  function updateCityFilter() {
    const filter = document.getElementById('cityFilter');
    const cities = Object.keys(cityStats).sort();
    
    while (filter.options.length > 1) {
      filter.remove(1);
    }
    
    cities.forEach(city => {
      const count = cityStats[city].total;
      const option = document.createElement('option');
      option.value = city;
      option.textContent = `${city} (${count} assets)`;
      filter.appendChild(option);
    });
    
    console.log('City filter updated with options:', cities.length, 'cities');
  }
  
  // Display site markers based on current visualization mode
  function displaySiteMarkers() {
    markerCluster.clearLayers();
    individualMarkers.forEach(marker => {
      if (map.hasLayer(marker)) {
        map.removeLayer(marker);
      }
    });
    individualMarkers = [];
    
    if (heatLayer) {
      map.removeLayer(heatLayer);
      heatLayer = null;
    }
    
    if (filteredSites.length === 0) {
      console.log('No sites to display after filtering');
      showNotification('No sites found with current filters', 'info');
      return;
    }
    
    const visualization = document.getElementById('siteLocationGrouping').value;
    currentVisualization = visualization;
    
    switch(visualization) {
      case 'cluster':
        displayClusteredSiteMarkers();
        break;
      case 'individual':
        displayIndividualSiteMarkers();
        break;
      case 'single':
        displaySingleSiteMarkersPerLocation();
        break;
      case 'spider':
        displaySpiderfiedSiteMarkers();
        break;
      case 'heatmap':
        displaySiteHeatmap();
        break;
    }
    
    updateSiteHealthIndicator();
  }
  
  // Display clustered site markers
  function displayClusteredSiteMarkers() {
    console.log(`Displaying ${filteredSites.length} sites in cluster mode`);
    
    filteredSites.forEach(site => {
      const marker = L.marker([site.latitude, site.longitude], {
        icon: getSiteIcon(site),
        site: site
      });
      
      marker.bindPopup(buildSitePopup(site));
      
      markerCluster.addLayer(marker);
    });
    
    map.addLayer(markerCluster);
  }
  
  // Display individual site markers
  function displayIndividualSiteMarkers() {
    console.log(`Displaying ${filteredSites.length} sites in individual marker mode`);
    
    filteredSites.forEach(site => {
      const marker = L.marker([site.latitude, site.longitude], {
        icon: getSiteIcon(site)
      });
      
      marker.bindPopup(buildSitePopup(site));
      
      marker.addTo(map);
      individualMarkers.push(marker);
    });
  }
  
  // Display single site marker per location
  function displaySingleSiteMarkersPerLocation() {
    console.log(`Displaying ${filteredSites.length} sites in single marker per location mode`);
    
    const locationGroups = {};
    filteredSites.forEach(site => {
      const locationKey = `${site.latitude.toFixed(4)},${site.longitude.toFixed(4)}`;
      if (!locationGroups[locationKey]) {
        locationGroups[locationKey] = [];
      }
      locationGroups[locationKey].push(site);
    });
    
    Object.values(locationGroups).forEach(sites => {
      if (sites.length > 0) {
        const site = sites[0];
        const marker = L.marker([site.latitude, site.longitude], {
          icon: getSiteIcon(site)
        });
        
        let popupContent = `<div class="popup-header"><h3>${sites.length} Sites at this Location</h3></div><div class="popup-content">`;
        sites.forEach(s => {
          const abbrev = getSiteTypeAbbreviation(s.siteType);
          popupContent += `<p><strong>${s.siteName || s.siteId}</strong> - ${abbrev} (${s.siteStatus})</p>`;
        });
        popupContent += '</div>';
        
        marker.bindPopup(popupContent);
        marker.addTo(map);
        individualMarkers.push(marker);
      }
    });
  }
  
  // Display spiderfied site markers
  function displaySpiderfiedSiteMarkers() {
    console.log(`Displaying ${filteredSites.length} sites in spiderfied mode`);
    
    filteredSites.forEach((site, index) => {
      const offsetLat = site.latitude + (Math.random() * 0.0005 - 0.00025);
      const offsetLng = site.longitude + (Math.random() * 0.0005 - 0.00025);
      
      const marker = L.marker([offsetLat, offsetLng], {
        icon: getSiteIcon(site)
      });
      
      marker.bindPopup(buildSitePopup(site));
      
      marker.addTo(map);
      individualMarkers.push(marker);
    });
  }
  
  // Display site heatmap
  function displaySiteHeatmap() {
    console.log(`Displaying ${filteredSites.length} sites in heatmap mode`);
    
    const heatData = filteredSites.map(site => {
      let intensity = 0.5;
      if (site.siteStatus === 'OUT_OF_SERVICE') intensity = 1.0;
      else if (site.siteStatus === 'STANDBY') intensity = 0.7;
      else if (site.siteStatus === 'WORKING') intensity = 0.3;
      else if (site.siteStatus === 'CWIP') intensity = 0.6;
      else if (site.siteStatus === 'TRANSFER') intensity = 0.4;
      
      return [site.latitude, site.longitude, intensity];
    });
    
    heatLayer = L.heatLayer(heatData, {
      radius: 20,
      blur: 12,
      maxZoom: 17,
      gradient: {0.4: 'blue', 0.6: 'lime', 0.8: 'yellow', 1.0: 'red'}
    }).addTo(map);
  }
  
  // Display assets based on current visualization mode
  function displayAssets() {
    markerCluster.clearLayers();
    individualMarkers.forEach(marker => {
      if (map.hasLayer(marker)) {
        map.removeLayer(marker);
      }
    });
    individualMarkers = [];
    
    if (heatLayer) {
      map.removeLayer(heatLayer);
      heatLayer = null;
    }
    
    if (filteredAssets.length === 0) {
      console.log('No assets to display after filtering');
      showNotification('No assets found with current filters', 'info');
      return;
    }
    
    const visualization = document.getElementById('locationGrouping').value;
    currentVisualization = visualization;
    
    switch(visualization) {
      case 'cluster':
        displayClusteredMarkers();
        break;
      case 'individual':
        displayIndividualMarkers();
        break;
      case 'single':
        displaySingleMarkersPerLocation();
        break;
      case 'spider':
        displaySpiderfiedMarkers();
        break;
      case 'heatmap':
        displayHeatmap();
        break;
    }
    
    updateHealthIndicator();
  }
  
  // Display clustered markers for assets
  function displayClusteredMarkers() {
    console.log(`Displaying ${filteredAssets.length} assets in cluster mode`);
    
    filteredAssets.forEach(asset => {
      const marker = L.marker([asset.latitude, asset.longitude], {
        icon: getAssetIcon(asset),
        asset: asset
      });
      
      marker.bindPopup(buildAssetPopup(asset));
      
      markerCluster.addLayer(marker);
    });
    
    map.addLayer(markerCluster);
  }
  
  // Display individual markers for assets
  function displayIndividualMarkers() {
    console.log(`Displaying ${filteredAssets.length} assets in individual marker mode`);
    
    filteredAssets.forEach(asset => {
      const marker = L.marker([asset.latitude, asset.longitude], {
        icon: getAssetIcon(asset)
      });
      
      marker.bindPopup(buildAssetPopup(asset));
      
      marker.addTo(map);
      individualMarkers.push(marker);
    });
  }
  
  // Display single marker per location for assets
  function displaySingleMarkersPerLocation() {
    console.log(`Displaying ${filteredAssets.length} assets in single marker per location mode`);
    
    const locationGroups = {};
    filteredAssets.forEach(asset => {
      const locationKey = `${asset.latitude.toFixed(4)},${asset.longitude.toFixed(4)}`;
      if (!locationGroups[locationKey]) {
        locationGroups[locationKey] = [];
      }
      locationGroups[locationKey].push(asset);
    });
    
    Object.values(locationGroups).forEach(assets => {
      if (assets.length > 0) {
        const asset = assets[0];
        const marker = L.marker([asset.latitude, asset.longitude], {
          icon: getAssetIcon(asset)
        });
        
        let popupContent = `<div class="popup-header"><h3>${assets.length} Assets at this Location</h3></div><div class="popup-content">`;
        assets.forEach(a => {
          const abbrev = getSiteTypeAbbreviation(a.siteTypeL2);
          popupContent += `<p><strong>${a.assetId}</strong> - ${abbrev} (${a.condition})</p>`;
        });
        popupContent += '</div>';
        
        marker.bindPopup(popupContent);
        marker.addTo(map);
        individualMarkers.push(marker);
      }
    });
  }
  
  // Display spiderfied markers for assets
  function displaySpiderfiedMarkers() {
    console.log(`Displaying ${filteredAssets.length} assets in spiderfied mode`);
    
    filteredAssets.forEach((asset, index) => {
      const offsetLat = asset.latitude + (Math.random() * 0.0005 - 0.00025);
      const offsetLng = asset.longitude + (Math.random() * 0.0005 - 0.00025);
      
      const marker = L.marker([offsetLat, offsetLng], {
        icon: getAssetIcon(asset)
      });
      
      marker.bindPopup(buildAssetPopup(asset));
      
      marker.addTo(map);
      individualMarkers.push(marker);
    });
  }
  
  // Display heatmap for assets
  function displayHeatmap() {
    console.log(`Displaying ${filteredAssets.length} assets in heatmap mode`);
    
    const heatData = filteredAssets.map(asset => {
      let intensity = 0.5;
      if (asset.condition === 'CRITICAL') intensity = 1.0;
      else if (asset.condition === 'POOR') intensity = 0.8;
      else if (asset.condition === 'FAIR') intensity = 0.6;
      else if (asset.condition === 'GOOD') intensity = 0.4;
      else if (asset.condition === 'VERY GOOD') intensity = 0.3;
      else if (asset.condition === 'EXCELLENT') intensity = 0.2;
      
      return [asset.latitude, asset.longitude, intensity];
    });
    
    heatLayer = L.heatLayer(heatData, {
      radius: 20,
      blur: 12,
      maxZoom: 17,
      gradient: {0.4: 'blue', 0.6: 'lime', 0.8: 'yellow', 1.0: 'red'}
    }).addTo(map);
  }
  
  // Apply site filters
  function applySiteFilters() {
    const siteCityFilter = document.getElementById('siteCityFilter').value;
    const siteTypeFilter = document.getElementById('siteTypeFilter').value;
    const siteStatusFilter = document.getElementById('siteStatusFilter').value;
    
    console.log('Applying site filters:', {
      siteCityFilter,
      siteTypeFilter,
      siteStatusFilter
    });
    
    filteredSites = allSites.filter(site => {
      let cityMatch = true;
      let typeMatch = true;
      let statusMatch = true;
      
      if (siteCityFilter !== 'all') {
        cityMatch = site.city === siteCityFilter;
      }
      
      if (siteTypeFilter !== 'all') {
        typeMatch = site.siteType === siteTypeFilter;
      }
      
      if (siteStatusFilter !== 'all') {
        statusMatch = site.siteStatus === siteStatusFilter;
      }
      
      return cityMatch && typeMatch && statusMatch;
    });
    
    console.log(`Filtered to ${filteredSites.length} sites`);
    
    if (currentTab === 'site') {
      displaySiteMarkers();
      updateCityPanel();
      updateSiteNameDisplay();
      updateSiteHealthIndicator();
    }
    
    if (siteCityFilter !== 'all' || siteTypeFilter !== 'all' || siteStatusFilter !== 'all') {
      showNotification(`Filter applied: ${filteredSites.length} sites found`, 'info');
    }
  }
  
  // Apply asset filters
  function applyFilters() {
    const conditionFilter = document.getElementById('conditionFilter').value;
    const siteFilter = document.getElementById('siteFilter').value;
    const cityFilter = document.getElementById('cityFilter').value;
    
    console.log('Applying filters:', {
      conditionFilter,
      siteFilter,
      cityFilter
    });
    
    filteredAssets = allAssets.filter(asset => {
      let conditionMatch = true;
      let siteMatch = true;
      let cityMatch = true;
      
      if (conditionFilter !== 'all') {
        conditionMatch = asset.condition === conditionFilter;
      }
      
      if (siteFilter !== 'all') {
        siteMatch = asset.siteNameL3 === siteFilter;
      }
      
      if (cityFilter !== 'all') {
        cityMatch = asset.city === cityFilter;
      }
      
      return conditionMatch && siteMatch && cityMatch;
    });
    
    console.log(`Filtered to ${filteredAssets.length} assets`);
    
    if (currentTab === 'asset') {
      displayAssets();
      updateCityPanel();
      updateSiteNameDisplay();
      updateHealthIndicator();
    }
    
    if (conditionFilter !== 'all' || siteFilter !== 'all' || cityFilter !== 'all') {
      showNotification(`Filter applied: ${filteredAssets.length} assets found`, 'info');
    }
  }
  
  // Filter site by city
  function filterSiteByCity() {
    const siteCityFilter = document.getElementById('siteCityFilter').value;
    const siteTypeFilter = document.getElementById('siteTypeFilter');
    
    if (siteCityFilter === 'all') {
      filteredSites = [...allSites];
      currentCity = null;
      map.flyTo([24.50, 39.65], 12, {
        duration: 1.5,
        easeLinearity: 0.25
      });
    } else {
      filteredSites = allSites.filter(s => s.city === siteCityFilter);
      currentCity = siteCityFilter;
      
      // Check if we have predefined coordinates for this city
      const cityName = siteCityFilter.toUpperCase();
      if (cityCoordinates[cityName]) {
        // Use predefined city center coordinates
        const coords = cityCoordinates[cityName];
        
        map.flyTo([coords.lat, coords.lng], 14, {
          duration: 1.5,
          easeLinearity: 0.25
        });
      } else if (filteredSites.length > 0) {
        // Fallback: calculate average coordinates if no predefined coordinates
        const totalLat = filteredSites.reduce((sum, site) => sum + site.latitude, 0);
        const totalLng = filteredSites.reduce((sum, site) => sum + site.longitude, 0);
        const avgLat = totalLat / filteredSites.length;
        const avgLng = totalLng / filteredSites.length;
        
        map.flyTo([avgLat, avgLng], 14, {
          duration: 1.5,
          easeLinearity: 0.25
        });
      }
    }
    
    updateSiteTypeFilter();
    updateSiteStatusFilter();
    
    siteTypeFilter.value = 'all';
    document.getElementById('siteStatusFilter').value = 'all';
    
    if (currentTab === 'site') {
      displaySiteMarkers();
      updateCityPanel();
      updateSiteNameDisplay();
      updateSiteHealthIndicator();
    }
  }
  
  // Filter site by type
  function filterSiteByType() {
    const siteTypeFilter = document.getElementById('siteTypeFilter').value;
    const siteCityFilter = document.getElementById('siteCityFilter');
    
    if (siteTypeFilter === 'all') {
      filteredSites = [...allSites];
    } else {
      filteredSites = allSites.filter(s => s.siteType === siteTypeFilter);
      
      if (filteredSites.length > 0 && currentTab === 'site') {
        const totalLat = filteredSites.reduce((sum, site) => sum + site.latitude, 0);
        const totalLng = filteredSites.reduce((sum, site) => sum + site.longitude, 0);
        const avgLat = totalLat / filteredSites.length;
        const avgLng = totalLng / filteredSites.length;
        
        map.flyTo([avgLat, avgLng], currentZoom > 14 ? currentZoom : 16, {
          duration: 1.5,
          easeLinearity: 0.25
        });
      }
    }
    
    updateSiteStatusFilter();
    
    document.getElementById('siteStatusFilter').value = 'all';
    
    if (currentTab === 'site') {
      displaySiteMarkers();
      updateCityPanel();
      updateSiteNameDisplay();
      updateSiteHealthIndicator();
    }
  }
  
  // Filter site by status
  function filterSiteByStatus(status) {
    if (status === 'all') {
      filteredSites = [...allSites];
    } else {
      filteredSites = allSites.filter(s => s.siteStatus === status);
    }
    
    document.getElementById('siteStatusFilter').value = status === 'all' ? 'all' : status;
    document.getElementById('siteTypeFilter').value = 'all';
    document.getElementById('siteCityFilter').value = 'all';
    
    updateSiteTypeFilter();
    updateSiteCityFilter();
    
    if (currentTab === 'site') {
      displaySiteMarkers();
      updateCityPanel();
      updateSiteNameDisplay();
      updateSiteHealthIndicator();
    }
    
    if (status !== 'all') {
      showNotification(`Filtered to ${status.replace('_', ' ').toLowerCase()} sites`, 'info');
    }
  }
  
  // Filter asset by city
  function filterByCity() {
    const cityFilter = document.getElementById('cityFilter').value;
    const siteFilter = document.getElementById('siteFilter');
    
    if (cityFilter === 'all') {
      filteredAssets = [...allAssets];
      currentCity = null;
      map.flyTo([24.50, 39.65], 12, {
        duration: 1.5,
        easeLinearity: 0.25
      });
    } else {
      filteredAssets = allAssets.filter(a => a.city === cityFilter);
      currentCity = cityFilter;
      
      // Check if we have predefined coordinates for this city
      const cityName = cityFilter.toUpperCase();
      if (cityCoordinates[cityName]) {
        // Use predefined city center coordinates
        const coords = cityCoordinates[cityName];
        
        map.flyTo([coords.lat, coords.lng], 14, {
          duration: 1.5,
          easeLinearity: 0.25
        });
      } else if (filteredAssets.length > 0) {
        // Fallback: calculate average coordinates if no predefined coordinates
        const totalLat = filteredAssets.reduce((sum, asset) => sum + asset.latitude, 0);
        const totalLng = filteredAssets.reduce((sum, asset) => sum + asset.longitude, 0);
        const avgLat = totalLat / filteredAssets.length;
        const avgLng = totalLng / filteredAssets.length;
        
        map.flyTo([avgLat, avgLng], 14, {
          duration: 1.5,
          easeLinearity: 0.25
        });
      }
    }
    
    updateSiteFilter();
    
    siteFilter.value = 'all';
    document.getElementById('conditionFilter').value = 'all';
    
    if (currentTab === 'asset') {
      displayAssets();
      updateCityPanel();
      updateSiteNameDisplay();
      updateHealthIndicator();
    }
  }
  
  // Filter asset by site
  function filterBySite() {
    const siteFilter = document.getElementById('siteFilter').value;
    const cityFilter = document.getElementById('cityFilter');
    
    if (siteFilter === 'all') {
      filteredAssets = [...allAssets];
      currentSite = null;
    } else {
      filteredAssets = allAssets.filter(a => a.siteNameL3 === siteFilter);
      currentSite = siteFilter;
      
      if (filteredAssets.length > 0 && currentTab === 'asset') {
        const totalLat = filteredAssets.reduce((sum, asset) => sum + asset.latitude, 0);
        const totalLng = filteredAssets.reduce((sum, asset) => sum + asset.longitude, 0);
        const avgLat = totalLat / filteredAssets.length;
        const avgLng = totalLng / filteredAssets.length;
        
        map.flyTo([avgLat, avgLng], currentZoom > 14 ? currentZoom : 16, {
          duration: 1.5,
          easeLinearity: 0.25
        });
      }
    }
    
    updateConditionFilter();
    
    document.getElementById('conditionFilter').value = 'all';
    
    if (currentTab === 'asset') {
      displayAssets();
      updateCityPanel();
      updateSiteNameDisplay();
      updateHealthIndicator();
    }
  }
  
  // Filter asset by status
  function filterByStatus(status) {
    if (status === 'all') {
      filteredAssets = [...allAssets];
    } else if (status === 'working') {
      filteredAssets = allAssets.filter(a => a.working === 'YES');
    } else if (status === 'not-working') {
      filteredAssets = allAssets.filter(a => a.working === 'NO');
    }
    
    document.getElementById('conditionFilter').value = 'all';
    document.getElementById('siteFilter').value = 'all';
    document.getElementById('cityFilter').value = 'all';
    currentSite = null;
    currentCity = null;
    
    updateConditionFilter();
    updateSiteFilter();
    updateCityFilter();
    
    if (currentTab === 'asset') {
      displayAssets();
      updateCityPanel();
      updateSiteNameDisplay();
      updateHealthIndicator();
    }
    
    if (status !== 'all') {
      showNotification(`Filtered to ${status.replace('-', ' ')} assets`, 'info');
    }
  }
  
  // Filter asset by type
  function filterByType(type) {
    if (type === 'all') {
      filteredAssets = [...allAssets];
    }
    
    if (currentTab === 'asset') {
      displayAssets();
    }
  }
  
  // Change site visualization mode
  function changeSiteVisualizationMode() {
    const mode = document.getElementById('siteLocationGrouping').value;
    if (currentTab === 'site') {
      displaySiteMarkers();
    }
  }
  
  // Change asset visualization mode
  function changeVisualizationMode() {
    const mode = document.getElementById('locationGrouping').value;
    if (currentTab === 'asset') {
      displayAssets();
    }
  }
  
  // Initialize everything
  function init() {
    initMap();
    loadThemePreference(); // Load theme preference before loading data
    loadCSVData();
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        toggleEquipmentPanel();
      }
      if (e.key === 'F1') {
        e.preventDefault();
        toggleDashboard();
      }
      if (e.key === '+' || e.key === '=') {
        e.preventDefault();
        map.zoomIn();
      }
      if (e.key === '-' || e.key === '_') {
        e.preventDefault();
        map.zoomOut();
      }
      // Theme toggle shortcut (Ctrl+Shift+T)
      if (e.ctrlKey && e.shiftKey && e.key === 'T') {
        e.preventDefault();
        toggleTheme();
      }
      // Tab switching shortcuts
      if (e.ctrlKey && e.key === '1') {
        e.preventDefault();
        switchTab('site');
      }
      if (e.ctrlKey && e.key === '2') {
        e.preventDefault();
        switchTab('asset');
      }
      // City tour shortcuts
      if (e.key === ' ') {
        e.preventDefault();
        if (tourIsPlaying) {
          pauseCityTour();
        } else {
          startCityTour();
        }
      }
      if (e.key === 'ArrowRight') {
        e.preventDefault();
        nextCity();
      }
      if (e.key === 'ArrowLeft') {
        e.preventDefault();
        previousCity();
      }
      if (e.key === 's' || e.key === 'S') {
        e.preventDefault();
        stopCityTour();
      }
    });
  }
  
  window.onload = init;
</script>

</body>
</html>
